<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="theme-color" content="#2563eb"/>
<title>JasperGYM</title>
<style>
:root{--bg:#91C6FF;--panel:#fff;--ink:#0f172a;--muted:#64748b;--brand:#2563eb;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;--border:#d1d5db;--field:#fff}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 140px}
/* é¡¶éƒ¨ï¼šå·¦ä¾§äº‘ç«¯ + å³ä¾§å¯¼èˆªï¼ˆç»Ÿä¸€æŒ‰é’®ï¼‰ */
.header{padding:8px 0 6px}
.headerbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.leftgrp{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.appTitle{font-weight:800;font-size:22px}
.btnrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
/* ç»Ÿä¸€æŒ‰é’®å¤–è§‚ï¼ˆäº‘ç«¯ + å¯¼èˆª + ä¸»è¦æ“ä½œï¼‰ */
.gbtn{appearance:none;background:#fff;color:#111;border:1px solid var(--border);border-radius:999px;padding:9px 16px;font-weight:700;cursor:pointer;line-height:1;height:40px;display:inline-flex;align-items:center;gap:6px}
.gbtn:hover{background:#f8fafc}.gbtn:active{transform:translateY(1px)}.gbtn[disabled]{opacity:.55;cursor:not-allowed}
/* é¡µé¢å†…æ“ä½œæŒ‰é’®ï¼šç»Ÿä¸€åˆ°ä¸ä¿å­˜æ³¨æ„äº‹é¡¹ç›¸åŒçš„è½»é‡å°ºå¯¸ */
.btn{border:none;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer;font-size:14px;line-height:1;height:40px}
.btn.brand{background:var(--brand);color:#fff}.btn.ok{background:var(--ok);color:#fff}.btn.warn{background:var(--warn);color:#fff}.btn.light{background:transparent;border:1px solid var(--border);color:#111}.btn.danger{background:var(--danger);color:#fff}
.btn.xs{height:32px;padding:6px 10px;font-size:12px;border-radius:10px}
/* å¯¼èˆªé€‰ä¸­æ€ */
.navbtn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
/* å…¶å®ƒåŸºç¡€ */
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 12px}
.row{display:grid;gap:16px}.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
select,input[type=text],input[type=number],input[type=color],textarea{width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
textarea{min-height:140px;resize:vertical}.bigtext{min-height:300px}.bigtextx3{min-height:900px}
.muted{color:var(--muted)}.tiny{font-size:12px}.hide{display:none}
/* é¦–é¡µ */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:12px;padding:12px;cursor:pointer}
.choice input{transform:scale(1.2)}.choice:hover{border-color:var(--brand)}.choice .name{font-weight:700}
.customOps{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.customTag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:6px 10px;border-radius:999px}
/* è®­ç»ƒ */
.timerGrid{display:grid;grid-template-columns:1fr 160px;gap:12px;align-items:center}
.timer{font-size:36px;font-weight:800;letter-spacing:1px}
.timerBtns{display:flex;flex-direction:column;gap:8px}.timerBtns .btn{width:100%}
#videoContainer{width:100%;height:640px;background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
#videoIframe,#videoHtml5{width:100%;height:100%;border:0;display:none}#videoFallback{display:none;color:#fff;padding:12px}
/* æ—¥å¿— */
.filterRow,.toolsRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.log-item{padding:16px 10px;border-bottom:1px solid var(--border);border-radius:8px;margin-bottom:10px}
.log-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.log-title{font-weight:700;cursor:pointer;margin-bottom:6px}.log-tags{font-size:12px;color:#64748b;margin-left:auto}
.log-content{margin-top:6px;white-space:pre-wrap;word-break:break-word;line-height:1.8}
.editBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
/* äº‘ç«¯çŠ¶æ€ç‚¹ */
.dot{width:10px;height:10px;border-radius:50%;background:#d1d5db;border:1px solid #94a3b8}
#cloudText{font-size:12px;color:var(--muted)}

/* â€”â€” åªéšè—æŒ‰é’®å¤–è§‚ï¼ŒåŠŸèƒ½ä»ä¿ç•™ â€”â€” */
.hide-btn{display:none !important}
/* ç»Ÿä¸€é¡¶éƒ¨æŒ‰é’®é«˜åº¦ï¼Œé¿å…â€œé«˜ä½ä¸é½â€ */
.gbtn,.pill{height:40px;line-height:40px}

/* æ—¥å¿—å¯Œåª’ä½“å±•ç¤º + å¤åˆ¶æ¡ï¼ˆæœ€å°æ ·å¼ï¼‰ */
.log-media{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.log-media img{max-height:120px;border-radius:8px;border:1px solid var(--border)}
.log-copybar{display:flex;justify-content:flex-end;margin-top:8px}

/* === æŒ‰é’®å¯¹é½ï¼ˆæå°èŒƒå›´ï¼‰ === */
#refVideoRow{display:grid;grid-template-columns:1fr 360px;gap:12px;align-items:center}
#refVideoRow .field select,#refVideoRow #openVideo.gbtn{height:40px;line-height:40px}
#refVideoRow #openVideo.gbtn{width:100%;display:flex;align-items:center;justify-content:center}

#page-settings .row.auto{align-items:center}
#page-settings .row.auto .btn.ok{height:40px;line-height:40px}

/* æ‰‹æœº */
@media (max-width: 900px){
  #refVideoRow{grid-template-columns:1fr}
}

/* è®¾ç½®å¡ç‰‡å†…ï¼šè¡Œå†…å‚ç›´å±…ä¸­ & æŒ‰é’®ç­‰é«˜ */
.card .sectionTitle + .row.auto{align-items:center}
.card .sectionTitle + .row.auto .btn.ok{height:40px;line-height:40px}

/* ç²¾å‡†ç¼©å°æŒ‰é’®å†…è¾¹è·ï¼Œé¿å…çœ‹èµ·æ¥æ¯”è¾“å…¥æ¡†é«˜ï¼ˆä»…ä½œç”¨äºè¿™ä¸¤å¤„ï¼‰ */
#refVideoRow #openVideo.gbtn,
.card .sectionTitle + .row.auto .btn.ok{
  padding-top:0!important;padding-bottom:0!important;
}

/* --- settings rows precise tune --- */
#timerRow, #brandRow { align-items:center; }
#timerRow .btn.ok, #brandRow .btn.ok{
  height:36px !important; line-height:36px !important; padding-top:0!important; padding-bottom:0!important;
}
#timerRow .field > label, #brandRow .field > label{ margin-bottom:6px; } /* keep label spacing consistent */

/* === VMåŒºè¡Œå¯¹é½ï¼štextarea ä¸â€œæ·»åŠ /æ›´æ–°â€åŒå³è¾¹ç•Œ === */
#vmRowTop{display:grid;grid-template-columns:1fr 1fr 1fr 140px;gap:12px;align-items:end}
#vmRowNotes{display:grid;grid-template-columns:1fr 1fr 1fr 140px;gap:12px;align-items:start}
#vmRowNotes .field.notes{grid-column:1 / span 3}
#vmRowTop .btn.ok,#vmRowNotes .btn.ok{height:36px;line-height:36px;padding-top:0;padding-bottom:0}

/* === ç²¾å‡†ï¼šåªä½œç”¨é¦–é¡µä¸è®¾ç½®é¡µçš„ row.auto === */
#page-home .row.auto, #page-settings .row.auto { align-items: center; }
#page-home .row.auto .gbtn, #page-home .row.auto .btn.ok,
#page-settings .row.auto .gbtn, #page-settings .row.auto .btn.ok {
  height:40px !important; line-height:40px !important; padding-top:0!important; padding-bottom:0!important;
}

/* === Jasper ä¿®æ­£ï¼šç»Ÿä¸€å¯¹é½ä¸ç§»åŠ¨ç«¯é€‚é…ï¼ˆæ¥è‡ªç”¨æˆ·ç»™å®šè§„èŒƒï¼‰ === */
/* ä¿®å¤è®­ç»ƒé¡µè¿›å…¥æŒ‰é’®å¯¹é½ */
#page-home .row.auto.vm-notes {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: center;
}
/* ä¿®å¤è®¾ç½®é¡µè§†é¢‘ç®¡ç†åŒºåŸŸå¯¹é½ */
#vmRowTop, #vmRowNotes {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr auto;
  gap: 12px;
  align-items: end;
}
#vmRowNotes .field.notes { grid-column: 1 / span 3; }
/* ç»Ÿä¸€è®¾ç½®é¡µæ‰€æœ‰æ“ä½œæŒ‰é’®é«˜åº¦ */
#page-settings .row.auto { align-items: end; }
#page-settings .row.auto .btn,
#page-settings .row.auto .gbtn {
  height: 40px;
  line-height: 40px;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
}
/* ä¿®å¤å€’è®¡æ—¶è®¾ç½®åŒºåŸŸ */
#timerRow, #brandRow {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 12px;
  align-items: end;
}
/* ä¿®å¤æ•°æ®ç®¡ç†æŒ‰é’®åŒºåŸŸ */
#page-settings .card:last-child .row.auto {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}
#page-settings .card:last-child .row.auto .btn {
  flex: 1;
  min-width: 200px;
  height: 40px;
  line-height: 40px;
}
/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 900px) {
  #page-home .row.auto.vm-notes,
  #vmRowTop, #vmRowNotes,
  #timerRow, #brandRow {
    grid-template-columns: 1fr;
    align-items: stretch;
  }
  #page-settings .card:last-child .row.auto .btn { min-width: 100%; }
  #vmRowNotes .field.notes { grid-column: 1; }
}

/* === ç®€æ´ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆä»…ç”¨äºâ€œè§†é¢‘ç¼–è¾‘ï¼šæ ‡é¢˜/é“¾æ¥/æ”¹å˜éƒ¨ä½â€ï¼‰ === */
/* ä¿è¯åˆå§‹éšè—ï¼šé¿å… .overlay çš„ display è¦†ç›–æ‰ .hide */
.overlay.hide{display:none!important}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;max-width:540px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal .row{display:grid;gap:12px}
.modal .row.auto{grid-template-columns:1fr 1fr}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

/* ===== JASPER FIXED8 ===== */
/* 1) éšè— JGym æ ‡é¢˜ */
#appTitle, .appTitle { display: none !important; }

/* 2) è®©ä¸¤ç»„æŒ‰é’®å¹¶æ’ä¸€æ’ï¼ˆä¸æ¢è¡Œï¼Œè¶…å‡ºå¯æ¨ªå‘æ»šåŠ¨ï¼‰ */
.headerbar { 
  display: flex !important;
  flex-wrap: nowrap !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 10px !important;
  overflow-x: auto;
}
.leftgrp, .btnrow, #tabs {
  display: flex !important;
  flex-wrap: nowrap !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 10px !important;
  margin: 0;
  padding: 0;
}

/* 3) ä¿ç•™ 8 ä¸ªæŒ‰é’®ï¼šéšè—äº‘ç«¯çŠ¶æ€ï¼ˆæ–‡æœ¬ä¸åœ†ç‚¹ï¼‰ */
#cloudText, #cloudDot { display: none !important; }

/* 4) æŒ‰é’®ç»Ÿä¸€å°ºå¯¸ï¼ˆæ²¿ç”¨ä½ ä¹‹å‰çš„è§„æ ¼ï¼‰ */
#btnLoad, #btnSave, #btnReadJson, #btnSaveJson,
#tabs .gbtn {
  height: 44px !important;
  min-width: 120px !important;
  width: 120px !important;
  border-radius: 999px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  padding: 0 14px !important;
  line-height: 1 !important;
}
/* ===== END FIXED8 ===== */

/* ===== JASPER FIXED9 ===== */
/* è§†é¢‘åˆ—è¡¨ï¼šç¼–è¾‘ä¸åˆ é™¤æŒ‰é’®å³å¯¹é½ï¼Œé—´è· 10px */
.vm-list-item {
  display: grid !important;
  grid-template-columns: 1fr auto auto !important;
  align-items: center !important;
  column-gap: 10px !important;
}
.vm-edit, .vm-del {
  justify-self: end !important;
  display: inline-flex !important;
  align-items: center !important;
  height: 32px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
}
.vm-edit { margin-right: 10px !important; }
.vm-del { margin-left: 10px !important; }
/* ===== END FIXED9 ===== */

/* ===== JASPER FIXED10 ===== */
/* Grid row with right-aligned edit/delete and 10px gap */
.vm-list-item {
  display: grid !important;
  grid-template-columns: 1fr auto auto !important;
  align-items: center !important;
  column-gap: 10px !important;
  width: 100%;
}
.vm-edit, .vm-del {
  justify-self: end !important;
  display: inline-flex !important;
  align-items: center !important;
  height: 32px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
}
.vm-edit { margin-right: 10px !important; }
.vm-del  { margin-left: 10px !important; }
/* ===== END FIXED10 ===== */

/* ===== JASPER FIXED11 ===== */
/* ç¡®ä¿åˆ—è¡¨å®¹å™¨ä¸ºå—çº§ï¼Œå­é¡¹ä¸€è¡Œä¸€ä¸ª */
#vmList { display: block !important; }
#vmList > * { display: block !important; width: 100% !important; }

/* æ¯è¡Œå¸ƒå±€ï¼šæ ‡é¢˜åœ¨å·¦ï¼ŒæŒ‰é’®åœ¨æœ€å³ï¼ŒæŒ‰é’®é—´è·10px */
#vmList > .vm-list-item {
  display: grid !important;
  grid-template-columns: 1fr auto auto !important;
  align-items: center !important;
  column-gap: 10px !important;
}
#vmList > .vm-list-item .vm-edit,
#vmList > .vm-list-item .vm-del {
  justify-self: end !important;
  display: inline-flex !important;
  align-items: center !important;
  height: 32px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
}
#vmList > .vm-list-item .vm-edit { margin-right: 10px !important; }
#vmList > .vm-list-item .vm-del  { margin-left: 10px !important; }
/* ===== END FIXED11 ===== */

/* ===== JASPER FIXED12 ===== */
/* ä¿è¯æ¯ä¸ªè§†é¢‘ç‹¬ç«‹ä¸€è¡Œï¼Œç¼–è¾‘ä¸åˆ é™¤æŒ‰é’®ä¹‹é—´å›ºå®š5pxé—´è· */
#vmList { display: block !important; }
#vmList > * { display: block !important; width: 100% !important; }

#vmList > .vm-list-item {
  display: grid !important;
  grid-template-columns: 1fr auto auto !important;
  align-items: center !important;
  column-gap: 5px !important;
}

#vmList > .vm-list-item .vm-edit,
#vmList > .vm-list-item .vm-del {
  justify-self: end !important;
  display: inline-flex !important;
  align-items: center !important;
  height: 32px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
}

#vmList > .vm-list-item .vm-edit { margin-right: 5px !important; }
#vmList > .vm-list-item .vm-del  { margin-left: 5px !important; }
/* ===== END FIXED12 ===== */

/* === Jasperï¼šç»Ÿä¸€é¡¶éƒ¨ 9 ä¸ªæŒ‰é’®å°ºå¯¸ï¼ˆä¸æ”¹å¸ƒå±€/é€»è¾‘ï¼‰ === */
#btnLoad, #btnSave, #btnReadJson, #btnSaveJson,
#tabs .gbtn {
  height: 44px !important;
  min-width: 120px !important;
  width: 120px !important;
  border-radius: 999px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  padding: 0 14px !important;
  line-height: 1 !important;
}

/* ===== JASPER FIXED17: æ‰‹æœºç«¯ä¸¤æ’æŒ‰é’®ç»Ÿä¸€ç­‰åˆ† ===== */
@media (max-width: 768px){
  /* æ•´ä½“å¤´éƒ¨ç«–æ’ */
  .headerbar{
    display: grid !important;
    grid-template-columns: 1fr !important;
    row-gap: 12px !important;
    justify-items: center !important;
  }
  
  /* ä¸¤æ’æŒ‰é’®å®¹å™¨ï¼š4åˆ—ç­‰åˆ†ç½‘æ ¼ */
  .leftgrp, #tabs{
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    column-gap: 10px !important;
    row-gap: 10px !important;
    width: 100% !important;
    justify-items: stretch !important;
  }
  
  /* ç»Ÿä¸€æ‰€æœ‰8ä¸ªæŒ‰é’®æ ·å¼ */
  #btnLoad, #btnSave, #btnReadJson, #btnSaveJson,
  #tabs .gbtn{
    width: 100% !important;
    min-width: 0 !important;
    height: 44px !important;
    border-radius: 999px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    white-space: nowrap !important;
    font-weight: 700 !important;
    font-size: 14px !important;
    line-height: 1 !important;
    padding: 0 10px !important;
    text-align: center !important;
  }
  
  /* éšè—çŠ¶æ€å…ƒç´  */
  #cloudDot, #cloudText{ display:none !important; }
}
/* ===== END FIXED17 ===== */

/* ===== è®­ç»ƒé¡µæŒ‰é’®ç»Ÿä¸€å¤§å° ===== */
#btnStartTimer, #btnStopTimer, #btnResetTimer {
  height: 44px !important;
  border-radius: 999px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  line-height: 1 !important;
  padding: 0 16px !important;
  min-width: 120px !important;
}

/* è®­ç»ƒé¡µå…¶ä»–ä¸»è¦æŒ‰é’®ç»Ÿä¸€ */
#btnEditTrain, #btnSaveTrain, #btnCancelTrain,
#btnStart {
  height: 44px !important;
  border-radius: 999px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 700 !important;
  padding: 0 16px !important;
  min-width: 120px !important;
}

</style>

<!-- ğŸ”¹ Favicon & PWA -->
<link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
<link rel="manifest" href="favicon_io/site.webmanifest">
<link rel="shortcut icon" href="favicon_io/favicon.ico">
<meta name="theme-color" content="#4285f4">

</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="headerbar">
      <!-- å·¦ä¾§ï¼šæ ‡é¢˜ + äº‘ç«¯ -->
      <div class="leftgrp">
        <div class="appTitle" id="appTitle">JasperGYM</div>
        <div class="btnrow">
          <button class="gbtn" id="btnVerify">éªŒè¯äº‘ç«¯</button>
          <button class="gbtn" id="btnPing">äº‘ç«¯è¿æ¥</button>
          <button class="gbtn" id="btnLoad" disabled>äº‘ç«¯è¯»å–</button>
          <button class="gbtn" id="btnSave" disabled>äº‘ç«¯ä¿å­˜</button>
          <button class="gbtn" id="btnReadJson">è¯»å–JSON</button>
          <button class="gbtn" id="btnSaveJson">ä¿å­˜JSON</button>
          <input type="file" id="jsonFilePicker" class="hide" accept=".json"/>
          <span class="dot" id="cloudDot"></span>
          <span id="cloudText" class="tiny">æœªè¿æ¥</span>
        </div>
      </div>
      <!-- å³ä¾§ï¼šä¸äº‘ç«¯æŒ‰é’®åŒæ ·å¤§å°çš„å¯¼èˆªæŒ‰é’® -->
      <div class="btnrow" id="tabs">
        <button class="gbtn navbtn active" data-page="home">ğŸ  é¦–é¡µ</button>
        <button class="gbtn navbtn" data-page="work">ğŸ’ª è®­ç»ƒ</button>
        <button class="gbtn navbtn" data-page="logs">ğŸ“˜ æ—¥å¿—</button>
        <button class="gbtn navbtn" data-page="settings">âš™ï¸ è®¾ç½®</button>
      </div>
    </div>
  </div>

  <!-- é¦–é¡µ -->
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">ä»Šå¤©è®­ç»ƒä»€ä¹ˆï¼Ÿ</div>
      <div class="choices" id="homeChoices"></div>
      <div class="row auto vm-notes" id="vmRowNotes" style="margin-top:10px">
        <div class="tiny muted">é€‰æ‹©åç‚¹å‡»å¼€å§‹ï¼›â€œè®¾ç½®â†’è§†é¢‘ç®¡ç†â€ç»´æŠ¤å„éƒ¨ä½çš„è§†é¢‘ä¸æ³¨æ„äº‹é¡¹ã€‚</div>
        <button class="btn brand" id="btnStart" type="button">è¿›å…¥è®­ç»ƒé¡µ</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn light" id="btnManageCustom" type="button">ç®¡ç†è‡ªå®šä¹‰</button>
        <div id="customMgr" class="hide card" style="margin:10px 0 0">
          <div class="row auto">
            <div class="field"><label>æ–°å¢è‡ªå®šä¹‰éƒ¨ä½</label>
              <input id="newCustomName" type="text" placeholder="å¦‚ï¼šå°è…¿ã€è‡€å¤–ä¾§â€¦">
            </div>
            <button class="btn ok" id="addCustom" type="button">æ·»åŠ </button>
          </div>
          <div id="customList" class="customOps"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- è®­ç»ƒ -->
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle">æœ¬æ¬¡è®­ç»ƒ</div>
      <div class="row auto">
        <div class="field"><label>è®­ç»ƒéƒ¨ä½</label><select id="workPart"></select></div>
      </div>
      <div class="timerGrid card" style="margin-top:10px">
        <div class="timer" id="timer">00:00</div>
        <div class="timerBtns">
          <button class="btn ok" id="btnStartTimer" type="button">å¼€å§‹å€’è®¡æ—¶</button>
          <button class="btn light" id="btnStopTimer" type="button">åœæ­¢</button>
          <button class="btn light" id="btnResetTimer" type="button">é‡ç½®</button>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="sectionTitle" style="margin:0">è®­ç»ƒè®°å½•</div>
          <div class="editBar">
            <button id="btnEditTrain" class="btn light" type="button">ç¼–è¾‘</button>
            <button id="btnSaveTrain" class="btn ok hide" type="button">ä¿å­˜</button>
            <button id="btnCancelTrain" class="btn light hide" type="button">å–æ¶ˆ</button>
          </div>
        </div>
        <div id="trainView" class="notice">æš‚æ— è®°å½•</div>
        <textarea id="trainEdit" class="bigtextx3 hide" placeholder="åœ¨æ­¤ç¼–è¾‘è®­ç»ƒè®°å½•â€¦"></textarea>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">å‚è€ƒè§†é¢‘</div>
      <div class="row auto" id="refVideoRow">
        <div class="field"><label>é€‰æ‹©è§†é¢‘</label><select id="videoSelect"></select></div>
        <div class="field"><label>&nbsp;</label><a id="openVideo" class="gbtn" style="text-decoration:none" target="_blank" href="#">æ‰“å¼€è§†é¢‘</a></div>
      </div>
      <div id="videoContainer" style="margin-top:8px">
        <iframe id="videoIframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        <video id="videoHtml5" controls></video>
        <div id="videoFallback" class="tiny">æš‚æ— è§†é¢‘</div>
      </div>
      <div class="notice" id="partNotice">æš‚æ— æ³¨æ„äº‹é¡¹</div>
    </div>
  </div>

  <!-- æ—¥å¿— -->
  <div id="page-logs" class="hide">
    <div class="card">
      <div class="sectionTitle">è®­ç»ƒæ—¥å¿—</div>
      <div class="filterRow"><label>ç­›é€‰éƒ¨ä½</label><select id="logFilter"></select></div>
      <div class="toolsRow">
        <button class="btn ok" id="toggleAddLog" type="button">â• æ·»åŠ æ—¥å¿—</button>
        <button class="btn light" id="toggleSort" type="button">âœï¸ ç¼–è¾‘/æ’åº</button>
        <button class="btn light" id="toggleOrder" type="button">æ˜¾ç¤ºé¡ºåºï¼šè‡ªå®šä¹‰</button>
      </div>
      <div id="addEditBox" class="hide card" style="margin-top:0">
        <div class="row auto">
          <div class="field"><label>éƒ¨ä½</label><select id="logPart"></select></div>
          <div class="field"><label>æ ‡é¢˜</label><input id="editTitle" type="text" placeholder="ç¬¬ä¸€è¡Œä¼šä½œä¸ºæ ‡é¢˜ï¼Œå¯åœ¨æ­¤é‡å†™"></div>
          <div class="field" style="grid-column:1/-1"><label>è§†é¢‘é“¾æ¥ï¼ˆå¯ç©ºæ ¼åˆ†éš”å¤šä¸ªï¼‰</label><input id="editMediaLinks" type="text" placeholder="ä¾‹å¦‚ï¼š https://youtu.be/... https://example.com/xxx.jpg"></div>
          <div class="field" style="grid-column:1/-1"><label>æ—¥å¿—å†…å®¹</label><textarea id="editContent" class="bigtext" placeholder="æ­£æ–‡ï¼ˆæ”¯æŒå¤šæ®µè½ï¼‰"></textarea></div>
        </div>
        <div class="row auto">
          <button class="btn ok" id="saveLog" type="button">ä¿å­˜</button>
          <button class="btn light" id="cancelEdit" type="button">å–æ¶ˆ</button>
        </div>
      </div>
      <div id="logList" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- è®¾ç½® -->
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle" id="vmTitle">ï¼ˆé€‰æ‹©éƒ¨ä½ï¼‰è§†é¢‘ & æ³¨æ„äº‹é¡¹</div>
      <div class="row auto vm-top" id="vmRowTop">
        <div class="field"><label>éƒ¨ä½</label><select id="vmPart"></select></div>
        <div class="field"><label>åç§°</label><input id="vmName" type="text" placeholder="å¦‚ï¼šæ·±è¹²åŠ¨ä½œè®²è§£"></div>
        <div class="field"><label>é“¾æ¥</label><input id="vmUrl" type="text" placeholder="https://â€¦ï¼ˆYouTube/MP4/é“¾æ¥ï¼‰"></div>
        <div class="field"><label>&nbsp;</label><button class="btn ok" id="vmAdd" type="button">æ·»åŠ /æ›´æ–°</button></div>
      </div>
      <div class="row auto vm-notes" id="vmRowNotes" style="margin-top:10px">
        <div class="field notes"><label>è¯¥éƒ¨ä½ã€Œè®­ç»ƒæ³¨æ„äº‹é¡¹ã€</label><textarea id="vmNotes" placeholder="è¦ç‚¹/å‘åŠ›/å¸¸è§é”™è¯¯â€¦ ä¸€è¡Œä¸€æ¡äº¦å¯"></textarea></div>
        <div class="field"><label>&nbsp;</label><button class="btn ok" id="saveNotes" type="button">ä¿å­˜æ³¨æ„äº‹é¡¹</button></div>
      </div>
      <div id="vmList" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <div class="sectionTitle">å€’è®¡æ—¶è®¾ç½®</div>
      <div class="row auto">
        <div class="field"><label>æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰</label><input id="intervalInput" type="number" min="10" max="999" step="1" value="60"/></div>
        <div class="field"><label>æç¤ºéŸ³é•¿åº¦ï¼ˆç§’ï¼‰</label><input id="beepLen" type="number" min="1" max="10" step="1" value="2"/></div>
        <div class="field"><label>&nbsp;</label><button class="btn ok" id="saveTimerPref" type="button">ä¿å­˜è®¡æ—¶è®¾ç½®</button></div>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">å¤–è§‚ / æ ‡è¯†</div>
      <div class="row auto">
        <div class="field"><label>è‡ªå®šä¹‰æ ‡é¢˜</label><input id="titleInput" type="text" placeholder="å¦‚ï¼šJasperGYM"></div>
        <div class="field"><label>ç‰ˆæœ¬å·</label><input id="verInput" type="text" placeholder="å¦‚ï¼šv3.37b"></div>
        <div class="field"><label>èƒŒæ™¯é¢œè‰²</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <div class="field"><label>&nbsp;</label><button class="btn ok" id="saveBrand" type="button">ä¿å­˜å¤–è§‚</button></div>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">æ•°æ®ç®¡ç†</div>
      <div class="row auto">
        <button class="btn danger" id="wipeAll" type="button">ğŸ—‘ æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼ˆä¸å¯æ¢å¤ï¼‰</button>
      </div>
    </div>
  </div>
</div>
<div id="toast" class="toast hide"></div>
<audio id="beepAudio" src="bell.mp3" preload="auto"></audio>

<script>
/* ====== åŸºç¡€å·¥å…· ====== */
// === æ“ä½œç¡®è®¤ï¼šé˜²è¯¯è§¦ ===
[['btnLoad','ç¡®è®¤ä»äº‘ç«¯è¯»å–é…ç½®ä¸æ•°æ®ï¼Ÿ'],['btnSave','ç¡®è®¤ä¿å­˜åˆ°äº‘ç«¯ï¼Ÿ'],['btnReadJson','ç¡®è®¤è¯»å– JSONï¼Ÿï¼ˆæœ¬åœ°/ç½‘ç»œï¼‰'],['btnSaveJson','ç¡®è®¤å¯¼å‡º/ä¸Šä¼  JSONï¼Ÿ'],['wipeAll','ç¡®å®šè¦æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼Ÿï¼ˆä¸å¯æ¢å¤ï¼‰']].forEach(([id,msg])=>{
  const el=document.getElementById(id);
  if(el){ el.addEventListener('click',(e)=>{ if(!window.confirm(msg)){ e.preventDefault(); e.stopImmediatePropagation(); } }, true); }
});

// === åª’ä½“é“¾æ¥ï¼šä»è¾“å…¥æ¡†è§£æä¸ºæ•°ç»„ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰ï¼Œä¿å­˜åˆ°å½“å‰æ—¥å¿— ===
document.getElementById('saveLog')?.addEventListener('click', ()=>{
  setTimeout(()=>{
    const raw = (document.getElementById('editMediaLinks')?.value||'').trim();
    if(!raw) return;
    const links = raw.split(/\s+/).filter(Boolean);
    let idx = (typeof editingIndex!=='undefined' && editingIndex!==null) ? editingIndex : (logs.length-1);
    if(idx<0 || !logs[idx]) idx = logs.length-1;
    if(idx>=0 && logs[idx]){
      logs[idx].mediaLinks = links;
      // å…¼å®¹ï¼šç§»é™¤æ—§çš„ photos / videoUrl
      delete logs[idx].photos;
      delete logs[idx].videoUrl;
      save('logs', logs);
      document.getElementById('editMediaLinks').value='';
      renderLogs();
    }
  }, 0);
});

// === å¯Œåª’ä½“è¾…åŠ© ===
function readFilesAsDataURLs(fileList){
  const files = Array.from(fileList||[]);
  return Promise.all(files.map(f => new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res({name:f.name, data: fr.result});
    fr.onerror = rej; fr.readAsDataURL(f);
  })));
}
// åœ¨åŸ saveLog æ‰§è¡Œåï¼Œè¡¥å†™ videoUrl / photosï¼Œå†ä¿å­˜å¹¶é‡æ¸²æŸ“
document.getElementById('saveLog')?.addEventListener('click', ()=>{
  setTimeout(async ()=>{
    try{
      const vEl = document.getElementById('editVideo');
      const pEl = document.getElementById('editPhotos');
      const videoUrl = vEl ? (vEl.value||'').trim() : '';
      let photos = [];
      if(pEl && pEl.files && pEl.files.length){ photos = await readFilesAsDataURLs(pEl.files); }
      if(!videoUrl && photos.length===0) return; // æ²¡æœ‰æ–°å¢åª’ä½“åˆ™ä¸æ”¹
      // æ¨æ–­å½“å‰ç´¢å¼•ï¼ˆæ–°å¢=æœ€åä¸€æ¡ï¼›ç¼–è¾‘=editingIndexï¼‰
      let idx = (typeof editingIndex!=='undefined' && editingIndex!==null) ? editingIndex : (logs.length-1);
      if(idx<0 || !logs[idx]) idx = logs.length-1;
      const old = logs[idx] || {};
      logs[idx] = {...old, videoUrl: videoUrl || old.videoUrl || '', photos: (photos.length? photos : (Array.isArray(old.photos)?old.photos:[]))};
      if(typeof save==='function') save(K.logs, logs);
      if(typeof renderLogs==='function') renderLogs();
    }catch(e){ console.error('augment media failed', e); }
  }, 0);
});

/* AUTO_HIDE_CLOUD_BTNS: åœ¨ä¸ç ´ååŠŸèƒ½çš„å‰æä¸‹éšè—â€œéªŒè¯äº‘ç«¯/äº‘ç«¯è¿æ¥â€ï¼Œå¹¶è‡ªåŠ¨è§¦å‘å®ƒä»¬ */
function _safe(el){return typeof el==='string'?document.getElementById(el):el}
function _hideBtn(id){const b=_safe(id); if(b){ b.classList.add('hide-btn'); }}
function _autoClick(id){const b=_safe(id); if(b){ try{ b.click(); }catch(e){} }}
window.addEventListener('DOMContentLoaded',()=>{
  _hideBtn('btnVerify'); _hideBtn('btnPing');             // ä»…éšè—å¤–è§‚
  setTimeout(()=>{ _autoClick('btnVerify'); _autoClick('btnPing'); }, 300); // ä¿æŒåŸæœ‰é€»è¾‘
});
/* JSON è¯»å†™ï¼ˆå¹¶è¡Œå­˜åœ¨ï¼Œä¸å½±å“äº‘ç«¯é€»è¾‘ï¼‰ */
function _downloadJson(name, obj){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=name||'jaspergym-data.json'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1200);
}
async function _fetchJson(url){
  const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
}
document.getElementById('btnReadJson')?.addEventListener('click', async ()=>{
  const mode=prompt('è¾“å…¥ URL ä»ç½‘ç»œè¯»å–ï¼›ç•™ç©ºåˆ™ä»æœ¬åœ°é€‰æ‹©æ–‡ä»¶','');
  if(mode && mode.trim()){
    try{
      const j=await _fetchJson(mode.trim());
      if(j.brand) brand=j.brand; if(j.prefs) { prefs=j.prefs; try{ prefs.part='å…¨éƒ¨'; }catch(e){} } if(j.videos) videos=j.videos;
      if(j.logs) logs=j.logs; if(j.notes) notes=j.notes; if(j.trainText) trainText=j.trainText;
      saveAll(); if(typeof boot==='function') boot(); if(typeof renderLogs==='function') renderLogs();
      prefs && (prefs.part = 'å…¨éƒ¨'); saveAll && saveAll();
toast('âœ… å·²ä»ç½‘ç»œ JSON å¯¼å…¥');
setTimeout(()=>{ 
  try{ 
    if(typeof renderLogFilters==='function') renderLogFilters();
    if(typeof renderLogs==='function') renderLogs();
    if(typeof refreshUI==='function') refreshUI();
    if(typeof boot==='function') boot();
  }catch(e){ console.error(e); }
}, 200);
    }catch(e){ toast('âŒ æ‹‰å–å¤±è´¥ï¼š'+e.message); }
  
  } else {
    // ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é€‰æ‹©å™¨ï¼Œé¿å… display:none å¯¼è‡´çš„ç‚¹å‡»è¢«æ‹¦æˆª
    const picker = document.createElement('input');
    picker.type = 'file';
    picker.accept = '.json,application/json';
    picker.style.position = 'fixed';
    picker.style.left = '-9999px';
    document.body.appendChild(picker);
    picker.onchange = async ()=>{
      try{
        const file = picker.files && picker.files[0];
        if(!file){ document.body.removeChild(picker); return; }
        const txt = await file.text();
        const j = JSON.parse(txt);
        if(j.brand) brand=j.brand; if(j.prefs) { prefs=j.prefs; try{ prefs.part='å…¨éƒ¨'; }catch(e){} } if(j.videos) videos=j.videos;
        if(j.logs) logs=j.logs; if(j.notes) notes=j.notes; if(j.trainText) trainText=j.trainText;
        if(typeof saveAll==='function') saveAll();
        if(typeof boot==='function') boot();
        if(typeof renderLogs==='function') renderLogs();
        prefs && (prefs.part = 'å…¨éƒ¨'); saveAll && saveAll();
toast('âœ… å·²ä»æœ¬åœ° JSON å¯¼å…¥');
setTimeout(()=>{ 
  try{ 
    if(typeof renderLogFilters==='function') renderLogFilters();
    if(typeof renderLogs==='function') renderLogs();
    if(typeof refreshUI==='function') refreshUI();
    if(typeof boot==='function') boot();
  }catch(e){ console.error(e); }
}, 200);
      }catch(e){
        console.error('JSON import error:', e);
        toast('âŒ è§£æå¤±è´¥ï¼š'+e.message);
      }finally{
        document.body.removeChild(picker);
      }
    };
    picker.click();
  }

});
document.getElementById('btnSaveJson')?.addEventListener('click', async ()=>{
  const url=prompt('ç•™ç©º=ç›´æ¥ä¸‹è½½ï¼›å¦‚éœ€ç½‘ç»œä¿å­˜è¯·è¾“å…¥æ¥æ”¶ JSON çš„ URLï¼ˆæ”¯æŒ PUT/POSTï¼‰','');
  const payload=typeof allPayload==='function'?allPayload():{brand,prefs,videos,logs,notes,trainText};
  if(!url){ _downloadJson('jaspergym-data.json', payload); toast('â¬‡ï¸ å·²å¯¼å‡ºä¸ºæ–‡ä»¶'); return; }
  try{
    let r=await fetch(url,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('HTTP '+r.status); }
    toast('âœ… å·²ä¸Šä¼ åˆ°ç½‘ç»œ URL');
  }catch(e){ toast('âŒ ç½‘ç»œä¿å­˜å¤±è´¥ï¼š'+e.message); }
});

const $=id=>document.getElementById(id);
const toast=t=>{const e=$('toast');if(!e)return; e.textContent=t;e.classList.remove('hide');e.style.opacity=1;setTimeout(()=>e.style.opacity=0,1600);setTimeout(()=>e.classList.add('hide'),2000)};
const setDot=(ok)=>{const d=$('cloudDot'); if(d) d.style.background=ok?'#10b981':'#ef4444'; const t=$('cloudText'); if(t) t.textContent=ok?'äº‘ç«¯å·²è¿æ¥':'ç¦»çº¿'};

/* ====== äº‘ç«¯ï¼ˆXHS æ¥æ³•ï¼Œå†™æ­» URL/Keyï¼‰ ====== */
const WORKER_URL='https://gym.sevenoy.workers.dev';
const ACCESS_KEY='jiajia11';
async function timedFetch(url,opts,ms){const ctl=new AbortController();const to=setTimeout(()=>ctl.abort(),ms||12000);try{const r=await fetch(url,{signal:ctl.signal,...(opts||{})});clearTimeout(to);return r}catch(e){clearTimeout(to);throw e}}
async function secureFetch(url,opts){const headers=Object.assign({},(opts&&opts.headers)||{}, {'X-Access-Key':ACCESS_KEY});return timedFetch(url,{...(opts||{}),headers},12000)}
async function cloudPing(){const r=await timedFetch(WORKER_URL+'/ping'); return r.text()}
async function cloudLoad(){try{const r=await secureFetch(WORKER_URL+'/',{method:'GET',cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); const j=await r.json(); setDot(true); toast('âœ… å·²ä»äº‘ç«¯è¯»å–'); return j}catch(e){ setDot(false); toast('âŒ äº‘ç«¯è¯»å–å¤±è´¥'); return null }}
async function cloudSave(payload){try{const r=await secureFetch(WORKER_URL+'/',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('HTTP '+r.status); setDot(true); toast('âœ… å·²ä¿å­˜åˆ°äº‘ç«¯'); return true}catch(e){ setDot(false); toast('âŒ äº‘ç«¯ä¿å­˜å¤±è´¥'); return false }}

/* ====== æœ¬åœ°æ•°æ®ç»“æ„ï¼ˆä¸ä½ æ—§ç‰ˆä¸€è‡´ï¼‰ ====== */
const K={brand:'gym_brand',prefs:'gym_prefs',videos:'gym_videos',logs:'gym_logs',notes:'gym_notes',trainText:'gym_traintext'};
let brand={title:'JasperGYM',ver:'',bg:'#91C6FF'};
let prefs={interval:60,beepLen:2,part:'legs',customParts:[],logOrder:'custom'};
let videos={legs:[],chest:[],back:[],arms:[],shoulders:[],core:[]};
let notes={legs:'',chest:'',back:'',arms:'',shoulders:'',core:''};
let trainText={};
let logs=[];

const load=(k,d)=>{try{const t=localStorage.getItem(k);return t?JSON.parse(t):d}catch{return d}};
const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
const loadAll=()=>{ brand=load(K.brand,brand); prefs=load(K.prefs,prefs); videos=load(K.videos,videos); logs=load(K.logs,logs); notes=load(K.notes,notes); trainText=load(K.trainText,trainText); };
const saveAll=()=>{ save(K.brand,brand); save(K.prefs,prefs); save(K.videos,videos); save(K.logs,logs); save(K.notes,notes); save(K.trainText,trainText); };
const allPayload=()=>({brand,prefs,videos,logs,notes,trainText});

/* ====== å¯¼èˆª ====== */
function setActive(page){['home','work','logs','settings'].forEach(p=>$('page-'+p)?.classList.add('hide')); $('page-'+page)?.classList.remove('hide'); document.querySelectorAll('.navbtn').forEach(el=>el.classList.remove('active')); document.querySelector(`.navbtn[data-page="${page}"]`)?.classList.add('active'); if(page==='work'){ renderWork() } if(page==='logs'){ renderLogFilters(); renderLogs(); }}
$('tabs')?.addEventListener('click',e=>{const el=e.target.closest('.navbtn'); if(el&&el.dataset.page) setActive(el.dataset.page)});
$('btnStart')?.addEventListener('click',()=>setActive('work'));

/* ====== é¦–é¡µ & è‡ªå®šä¹‰ ====== */
const baseParts=[{id:'legs',name:'è…¿éƒ¨'},{id:'chest',name:'èƒ¸éƒ¨'},{id:'back',name:'èƒŒéƒ¨'},{id:'arms',name:'æ‰‹è‡‚'},{id:'shoulders',name:'è‚©éƒ¨'},{id:'core',name:'æ ¸å¿ƒ'}];
const allParts=()=>[...baseParts,...(prefs.customParts||[]).map(n=>({id:'c_'+encodeURIComponent(n),name:n}))];
const partName=id=>(allParts().find(p=>p.id===id)||{name:'æœªå‘½å'}).name;
const ensureBucket=id=>{ if(!videos[id]) videos[id]=[]; if(!notes[id]) notes[id]=''; if(!trainText[id]) trainText[id]={all:''}; };
function renderHomeChoices(){ const box=$('homeChoices'); if(!box) return; box.innerHTML=''; baseParts.forEach(p=>box.appendChild(choice(p))); (prefs.customParts||[]).forEach(n=>box.appendChild(choice({id:'c_'+encodeURIComponent(n),name:n}))); const add=document.createElement('div'); add.className='choice'; add.innerHTML='<input type="radio" disabled/><span class="name">è‡ªå®šä¹‰</span>'; add.onclick=()=>{ $('btnManageCustom')?.click(); $('newCustomName')?.focus(); }; box.appendChild(add)}
function choice(p){ const d=document.createElement('div'); d.className='choice'; d.innerHTML='<input type="radio" name="part" '+(prefs.part===p.id?'checked':'')+'/><span class="name">'+p.name+'</span>'; d.onclick=()=>{prefs.part=p.id; save(K.prefs,prefs)}; return d }
$('btnManageCustom')?.addEventListener('click',()=>$('customMgr')?.classList.toggle('hide'));
$('addCustom')?.addEventListener('click',()=>{ const name=($('newCustomName')?.value||'').trim(); if(!name) return toast('è¯·è¾“å…¥åç§°'); if((prefs.customParts||[]).includes(name)) return toast('å·²å­˜åœ¨'); (prefs.customParts=prefs.customParts||[]).push(name); save(K.prefs,prefs); $('newCustomName').value=''; const id='c_'+encodeURIComponent(name); ensureBucket(id); saveAll(); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('å·²æ·»åŠ ') });
function renderCustomList(){ const box=$('customList'); if(!box) return; box.innerHTML=''; (prefs.customParts||[]).forEach((name,idx)=>{ const id='c_'+encodeURIComponent(name); const tag=document.createElement('div'); tag.className='customTag'; const nm=document.createElement('span'); nm.textContent=name; const edit=document.createElement('button'); edit.className='btn xs light'; edit.textContent='é‡å‘½å'; const del=document.createElement('button'); del.className='btn xs danger'; del.textContent='åˆ é™¤'; edit.onclick=()=>{ const nn=prompt('é‡å‘½åä¸ºï¼š',name); if(!nn||!nn.trim())return; if(prefs.customParts.includes(nn.trim())) return toast('å·²å­˜åœ¨'); const newId='c_'+encodeURIComponent(nn.trim()); videos[newId]=videos[id]||[]; notes[newId]=notes[id]||''; trainText[newId]=trainText[id]||{all:''}; delete videos[id]; delete notes[id]; delete trainText[id]; prefs.customParts[idx]=nn.trim(); if(prefs.part===id) prefs.part=newId; saveAll(); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('å·²é‡å‘½å') }; del.onclick=()=>{ if(!confirm('åˆ é™¤è¯¥è‡ªå®šä¹‰éƒ¨ä½ï¼Ÿ'))return; prefs.customParts.splice(idx,1); delete videos[id]; delete notes[id]; delete trainText[id]; if(prefs.part===id) prefs.part='legs'; saveAll(); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('å·²åˆ é™¤') }; tag.appendChild(nm); tag.appendChild(edit); tag.appendChild(del); box.appendChild(tag) }) }

/* ====== è®­ç»ƒï¼šè®¡æ—¶/è®°å½•/è§†é¢‘ ====== */
let timerId=null,remain=0;
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const resetCountdown=()=>{ stopCountdown(); remain=parseInt(prefs.interval||60,10); const el=$('timer'); if(el) el.textContent=fmt(remain)};
const tick=()=>{ const el=$('timer'); if(!el) return; if(remain<=0){ stopCountdown(); beep(); return } el.textContent=fmt(remain--) };
function startCountdown(){ stopCountdown(); remain=parseInt(prefs.interval||60,10); $('timer').textContent=fmt(remain); tick(); timerId=setInterval(tick,1000) }
function stopCountdown(){ if(timerId){clearInterval(timerId);timerId=null} }
function beep(){ try{const a=document.getElementById('beepAudio'); if(!a) return; a.currentTime=0; a.play(); setTimeout(()=>a.pause(), (prefs.beepLen||2)*1000)}catch(e){} }
$('btnStartTimer')?.addEventListener('click',startCountdown);
$('btnStopTimer')?.addEventListener('click',stopCountdown);
$('btnResetTimer')?.addEventListener('click',resetCountdown);

function renderTrainView(){ ensureBucket(prefs.part); const v=(trainText[prefs.part]?.all)||''; const view=$('trainView'); if(view) view.textContent=v||'æš‚æ— è®°å½•'; const edit=$('trainEdit'); if(edit&&!edit.classList.contains('hide')) edit.value=v }
$('btnEditTrain')?.addEventListener('click',()=>{ ensureBucket(prefs.part); const edit=$('trainEdit'), view=$('trainView'); if(!edit||!view) return; edit.value=(trainText[prefs.part]?.all)||''; edit.classList.remove('hide'); view.classList.add('hide'); $('btnEditTrain').classList.add('hide'); $('btnSaveTrain').classList.remove('hide'); $('btnCancelTrain').classList.remove('hide') });
$('btnCancelTrain')?.addEventListener('click',()=>{ $('trainEdit')?.classList.add('hide'); $('trainView')?.classList.remove('hide'); $('btnEditTrain')?.classList.remove('hide'); $('btnSaveTrain')?.classList.add('hide'); $('btnCancelTrain')?.classList.add('hide') });
$('btnSaveTrain')?.addEventListener('click',()=>{ const edit=$('trainEdit'); if(!edit) return; ensureBucket(prefs.part); trainText[prefs.part].all=edit.value||''; save(K.trainText,trainText); renderTrainView(); $('trainEdit').classList.add('hide'); $('trainView').classList.remove('hide'); $('btnEditTrain').classList.remove('hide'); $('btnSaveTrain').classList.add('hide'); $('btnCancelTrain').classList.add('hide'); toast('è®­ç»ƒè®°å½•å·²ä¿å­˜') });

const toYT=u=>{try{const x=new URL(u); if(x.hostname.includes('youtube.com')&&x.searchParams.get('v'))return`https://www.youtube.com/embed/${x.searchParams.get('v')}`; if(x.hostname.includes('youtu.be'))return`https://www.youtube.com/embed/${x.pathname.replace('/','')}`}catch{} return null};
function stopAllVideo(){ const iframe=$('videoIframe'),vid=$('videoHtml5'),fb=$('videoFallback'); try{vid&&vid.pause()}catch(e){} if(iframe) iframe.src=''; if(vid) vid.src=''; if(iframe) iframe.style.display='none'; if(vid) vid.style.display='none'; if(fb) fb.style.display='none' }
function previewVideo(url){ const iframe=$('videoIframe'),vid=$('videoHtml5'),fb=$('videoFallback'); stopAllVideo(); if(!url){ fb&&(fb.textContent='æš‚æ— è§†é¢‘',fb.style.display='block'); return } const yt=toYT(url); if(yt&&iframe){ iframe.src=yt; iframe.style.display='block'; return } if(/\.(mp4|webm|ogg)(\?.*)?$/i.test(url) && vid){ vid.src=url; vid.style.display='block'; return } fb&&(fb.textContent='æ­¤é“¾æ¥æ— æ³•å†…åµŒæ’­æ”¾ï¼Œè¯·ç‚¹å‡»â€œæ‰“å¼€è§†é¢‘â€ã€‚',fb.style.display='block') }
function refreshVideoUI(partId){ ensureBucket(partId); const vs=$('videoSelect'); if(!vs) return; vs.innerHTML=''; const arr=videos[partId]||[]; if(!arr.length){ const o=document.createElement('option'); o.value=''; o.textContent='æ— è§†é¢‘'; vs.appendChild(o); previewVideo('') } else { arr.forEach((it,idx)=>{ const o=document.createElement('option'); o.value=idx; o.textContent=it.name; vs.appendChild(o) }); vs.value=0; previewVideo(arr[0].url) } vs.onchange=()=>{ const i=vs.value; if(i===''||i==null){previewVideo('');return} previewVideo((videos[partId]||[])[i].url) }; const a=document.getElementById('openVideo'); if(a) a.onclick=()=>{ const i=vs.value; if(i===''||i==null){toast('è¯¥éƒ¨ä½æš‚æ— è§†é¢‘');return} window.open((videos[partId]||[])[i].url,'_blank') }; const pn=document.getElementById('partNotice'); if(pn) pn.textContent=notes[partId]||'æš‚æ— æ³¨æ„äº‹é¡¹' }
function renderWork(){ const sel=$('workPart'); if(!sel) return; sel.innerHTML=''; allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id)) ); sel.value=prefs.part; ensureBucket(prefs.part); renderTrainView(); refreshVideoUI(prefs.part); resetCountdown(); sel.onchange=()=>{ prefs.part=sel.value; save(K.prefs,prefs); ensureBucket(prefs.part); renderTrainView(); refreshVideoUI(prefs.part); stopAllVideo(); } }

/* ====== æ—¥å¿— ====== */
let sortMode=false,editingIndex=null;
function renderLogFilters(){ const sel=$('logFilter'); if(!sel) return; sel.innerHTML=''; sel.appendChild(new Option('å…¨éƒ¨','all')); allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id))); sel.onchange=renderLogs; const partSel=$('logPart'); if(partSel){ partSel.innerHTML=''; allParts().forEach(p=> partSel.appendChild(new Option(p.name,p.id))); partSel.value=prefs.part } }
$('toggleAddLog')?.addEventListener('click',()=>{ editingIndex=null; const t1=$('editTitle'); const t2=$('editContent'); const p=$('logPart'); if(t1) t1.value=''; if(t2) t2.value=''; if(p) p.value=prefs.part; $('addEditBox')?.classList.toggle('hide') });
$('cancelEdit')?.addEventListener('click',()=>$('addEditBox')?.classList.add('hide'));
$('saveLog')?.addEventListener('click',()=>{ const title=($('editTitle')?.value||'').trim(); const content=($('editContent')?.value||'').trim(); if(!title && !content) return toast('è¯·è‡³å°‘å¡«å†™æ ‡é¢˜æˆ–æ­£æ–‡'); const pid=($('logPart')?.value)||prefs.part; const finalTitle=title || (content.split(/\r?\n/)[0]||'ï¼ˆæ— æ ‡é¢˜ï¼‰'); const id=crypto.randomUUID?crypto.randomUUID():('id_'+Date.now()+Math.random()); if(editingIndex===null){ logs.push({id,title:finalTitle,content,part:pid,ts:Date.now()}); } else { logs[editingIndex]={...logs[editingIndex],title:finalTitle,content,part:pid}; } save(K.logs,logs); $('addEditBox')?.classList.add('hide'); renderLogs(); toast('å·²ä¿å­˜') });
$('toggleSort')?.addEventListener('click',()=>{ sortMode=!sortMode; renderLogs() });
$('toggleOrder')?.addEventListener('click',()=>{ prefs.logOrder=(prefs.logOrder==='custom'?'time':'custom'); save(K.prefs,prefs); renderLogs(); toast(prefs.logOrder==='custom'?'æŒ‰è‡ªå®šä¹‰é¡ºåºæ˜¾ç¤º':'æŒ‰æ—¶é—´å€’åºæ˜¾ç¤º'); });
function renderLogs(){ const box=$('logList'); if(!box) return; box.innerHTML=''; $('toggleOrder').textContent='æ˜¾ç¤ºé¡ºåºï¼š'+(prefs.logOrder==='custom'?'è‡ªå®šä¹‰':'æŒ‰æ—¶é—´'); const filter=($('logFilter')?.value)||'all'; let idxs=[]; for(let i=0;i<logs.length;i++){ if(filter==='all'||logs[i].part===filter) idxs.push(i) } const order = sortMode ? idxs : (prefs.logOrder==='time' ? [...idxs].sort((a,b)=> (logs[b].ts||0)-(logs[a].ts||0)) : idxs); if(!order.length){ box.innerHTML='<div class="tiny muted">æš‚æ— æ—¥å¿—ã€‚</div>'; return } order.forEach((realIndex)=>{ const lg=logs[realIndex]; const item=document.createElement('div'); item.className='log-item'; const head=document.createElement('div'); head.className='log-head'; const title=document.createElement('div'); title.className='log-title'; title.textContent=lg.title||'ï¼ˆæ— æ ‡é¢˜ï¼‰'; const tags=document.createElement('div'); tags.className='log-tags'; tags.textContent=partName(lg.part||''); head.appendChild(title); head.appendChild(tags); item.appendChild(head); const content=document.createElement('div'); content.className='log-content hide'; content.textContent=lg.content||'ï¼ˆæ— å†…å®¹ï¼‰'; title.onclick=()=>content.classList.toggle('hide'); item.appendChild(content);
    // å¯Œåª’ä½“å±•ç¤º + å¤åˆ¶å†…å®¹æŒ‰é’®
    try{
      const media=document.createElement('div'); media.className='log-media';
      const mlinks = Array.isArray(lg.mediaLinks) ? lg.mediaLinks : [];
      if(mlinks.length){
        mlinks.forEach(u=>{ const s=(u||'').toLowerCase(); const isV = s.includes('youtube.com')||s.includes('youtu.be')||s.includes('vimeo.com')||s.endsWith('.mp4')||s.endsWith('.webm')||s.endsWith('.m3u8'); if(isV){ const a=document.createElement('a'); a.href=u; a.target='_blank'; a.textContent='â–¶ æ‰“å¼€è§†é¢‘'; media.appendChild(a);} else { const img=new Image(); img.src=u; img.alt='media'; media.appendChild(img);} });
      } else {
        if(lg.videoUrl){ const av=document.createElement('a'); av.href=lg.videoUrl; av.target='_blank'; av.textContent='â–¶ æ‰“å¼€è§†é¢‘'; media.appendChild(av); }
        if(Array.isArray(lg.photos)){
          lg.photos.forEach(ph=>{ const img=new Image(); img.src=ph.data||ph; img.alt=ph.name||'photo'; media.appendChild(img); });
        }
      }
      const copybar=document.createElement('div'); copybar.className='log-copybar';
      const cp=document.createElement('button'); cp.className='btn xs light'; cp.textContent='å¤åˆ¶å†…å®¹';
      cp.onclick=(e)=>{ e.stopPropagation(); const extra=(lg.videoUrl?'\nè§†é¢‘ï¼š'+lg.videoUrl:'') + (Array.isArray(lg.photos)&&lg.photos.length?'\nå›¾ç‰‡ï¼š'+lg.photos.map(p=>p.name||'img').join(', '):''); const txt=(lg.title||'')+'\n\n'+(lg.content||'')+extra; navigator.clipboard.writeText(txt).then(()=>alert('å¤åˆ¶æˆåŠŸ')).catch(()=>toast('å¤åˆ¶å¤±è´¥')); };
      copybar.appendChild(cp);
      content.appendChild(media);
      content.appendChild(copybar);
    }catch(_){}
 if(sortMode){ const tools=document.createElement('div'); tools.className='toolsRow'; tools.innerHTML='<button class="btn xs light">â¬†ï¸ ä¸Šç§»</button><button class="btn xs light">â¬‡ï¸ ä¸‹ç§»</button><button class="btn xs light">âœï¸ ç¼–è¾‘</button><button class="btn xs danger">ğŸ—‘ åˆ é™¤</button>'; const [upBtn,downBtn,editBtn,delBtn]=tools.querySelectorAll('button'); upBtn.onclick=(e)=>{e.stopPropagation(); moveInFiltered(filter, realIndex, -1) }; downBtn.onclick=(e)=>{e.stopPropagation(); moveInFiltered(filter, realIndex, +1) }; editBtn.onclick=(e)=>{e.stopPropagation(); editingIndex=realIndex; $('addEditBox')?.classList.remove('hide'); const p=$('logPart'); if(p) p.value=lg.part||prefs.part; const t1=$('editTitle'); const t2=$('editContent'); if(t1) t1.value=lg.title||''; if(t2) t2.value=lg.content||''; window.scrollTo({top:0,behavior:'smooth'}); }; delBtn.onclick=(e)=>{e.stopPropagation(); logs.splice(realIndex,1); save(K.logs,logs); renderLogs(); }; item.appendChild(tools); } box.appendChild(item) }) }
function moveInFiltered(filter, realIndex, delta){ const indices=[]; for(let i=0;i<logs.length;i++){ if(filter==='all'||logs[i].part===filter) indices.push(i) } const pos=indices.indexOf(realIndex); if(pos<0) return; const targetPos=pos+delta; if(targetPos<0||targetPos>=indices.length) return; const a=indices[pos], b=indices[targetPos]; [logs[a],logs[b]]=[logs[b],logs[a]]; save(K.logs,logs); renderLogs() }

/* ====== è®¾ç½®/è§†é¢‘ ====== */
function renderVmPartOptions(){ const sel=$('vmPart'); if(!sel) return; sel.innerHTML=''; allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id)) ); sel.value=prefs.part; const tit=$('vmTitle'); if(tit) tit.textContent=partName(sel.value)+' è§†é¢‘ & æ³¨æ„äº‹é¡¹'; const n=$('vmNotes'); if(n) n.value=notes[sel.value]||''; renderVmList() }
$('vmPart')?.addEventListener('change',()=>{ const tit=$('vmTitle'); if(tit) tit.textContent=partName($('vmPart').value)+' è§†é¢‘ & æ³¨æ„äº‹é¡¹'; const n=$('vmNotes'); if(n) n.value=notes[$('vmPart').value]||''; renderVmList() });
$('saveNotes')?.addEventListener('click',()=>{ const id=($('vmPart')?.value)||prefs.part; notes[id]=($('vmNotes')?.value)||''; save(K.notes,notes); if(prefs.part===id){ const pn=$('partNotice'); if(pn) pn.textContent=notes[id]||'' } toast('æ³¨æ„äº‹é¡¹å·²ä¿å­˜') });
$('vmAdd')?.addEventListener('click',()=>{ const part=($('vmPart')?.value)||prefs.part, name=($('vmName')?.value||'').trim(), url=($('vmUrl')?.value||'').trim(); if(!name||!url) return toast('åç§°å’Œé“¾æ¥éƒ½è¦å¡«'); ensureBucket(part); const arr=videos[part]; const idx=arr.findIndex(x=>x.name===name); const item={name,url}; if(idx>=0) arr[idx]=item; else arr.push(item); save(K.videos,videos); $('vmName').value=''; $('vmUrl').value=''; renderVmList(); toast('å·²ä¿å­˜') });
function renderVmList(){ const part=($('vmPart')?.value)||prefs.part; ensureBucket(part); const box=$('vmList'); if(!box) return; box.innerHTML=''; const arr=videos[part]; if(!arr.length){ box.innerHTML='<div class="tiny muted">è¯¥éƒ¨ä½æš‚æ— è§†é¢‘ã€‚</div>'; return } arr.forEach((it,idx)=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0'; row.style.borderBottom='1px solid var(--border)'; const left=document.createElement('div'); left.textContent=it.name; left.title=it.url; const right=document.createElement('div'); const edit=document.createElement('button'); edit.className='btn xs light'; edit.textContent='âœï¸ ç¼–è¾‘'; const del=document.createElement('button'); del.className='btn xs danger'; del.textContent='ğŸ—‘ åˆ é™¤'; edit.onclick=()=>{ openVmEdit(part, idx); }; del.onclick=()=>{ arr.splice(idx,1); save(K.videos,videos); renderVmList(); }; right.appendChild(edit); right.appendChild(del); row.appendChild(left); row.appendChild(right); box.appendChild(row) }) }

/* === è®¾ç½®é¡µè§†é¢‘ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆæ”¯æŒæ”¹éƒ¨ä½ï¼‰ === */
let vmEditCtx = { part: null, idx: -1 };
function openVmEdit(part, idx){
  ensureBucket(part);
  vmEditCtx = { part, idx };
  const it = (videos[part]||[])[idx] || {name:'', url:''};
  const t = document.getElementById('vmEditTitle');
  const u = document.getElementById('vmEditUrl');
  const p = document.getElementById('vmEditPart');
  if(p){ p.innerHTML=''; allParts().forEach(pp=> p.appendChild(new Option(pp.name, pp.id))); p.value = part; }
  if(t) t.value = it.name || '';
  if(u) u.value = it.url || '';
  const d = document.getElementById('vmEditDlg');
  if(d){ 
    d.classList.remove('hide');
    // ç»‘å®šæŒ‰é’®ï¼ˆåœ¨æ‰“å¼€æ—¶ç»‘å®šï¼Œç¡®ä¿å…ƒç´ å·²åœ¨DOMé‡Œï¼‰
    const cancelBtn = document.getElementById('vmEditCancel');
    const saveBtn   = document.getElementById('vmEditSave');
    if(cancelBtn) cancelBtn.onclick = ()=>{ document.getElementById('vmEditDlg')?.classList.add('hide'); };
    if(saveBtn)   saveBtn.onclick   = ()=>{
      const tval = (document.getElementById('vmEditTitle')?.value||'').trim();
      const uval = (document.getElementById('vmEditUrl')?.value||'').trim();
      const np   = (document.getElementById('vmEditPart')?.value)||vmEditCtx.part;
      if(!tval || !uval){ toast('æ ‡é¢˜å’Œé“¾æ¥éƒ½è¦å¡«'); return; }
      const op = vmEditCtx.part, i = vmEditCtx.idx;
      if(np === op){
        if(videos[op] && videos[op][i]) videos[op][i] = { name: tval, url: uval };
      }else{
        ensureBucket(np);
        const item = { name: tval, url: uval };
        if(videos[op]){ videos[op].splice(i, 1); }
        (videos[np] = videos[np] || []).push(item);
      }
      save(K.videos, videos);
      document.getElementById('vmEditDlg')?.classList.add('hide');
      renderVmList();
      if(prefs.part === vmEditCtx.part || prefs.part === np){
        try{ refreshVideoUI(prefs.part); }catch(_){}
      }
      toast('å·²ä¿å­˜');
    };
  }
}
// å…è®¸æŒ‰ ESC å…³é—­
window.addEventListener('keydown', (ev)=>{
  if(ev.key === 'Escape'){ document.getElementById('vmEditDlg')?.classList.add('hide'); }
});
/* ====== å¤–è§‚/æ•°æ® ====== */

$('saveBrand')?.addEventListener('click',()=>{ brand.title=($('titleInput')?.value)||brand.title; brand.ver=($('verInput')?.value)||brand.ver; brand.bg=($('bgColor')?.value)||brand.bg; save(K.brand,brand); const t=$('appTitle'); if(t) t.textContent=brand.title; document.documentElement.style.setProperty('--bg', brand.bg); toast('å¤–è§‚å·²ä¿å­˜') });
$('exportAll')?.addEventListener('click',()=>{ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(allPayload(),null,2)); a.download='jaspergym-data.json'; a.click() });
$('importAll')?.addEventListener('click',()=>$('importFile')?.click());
$('importFile')?.addEventListener('change',async e=>{ const f=e.target.files[0]; if(!f) return; const text=await f.text(); try{ const obj=JSON.parse(text); if(obj.brand)brand=obj.brand; if(obj.prefs)prefs=obj.prefs; if(obj.videos)videos=obj.videos; if(obj.logs)logs=obj.logs; if(obj.notes)notes=obj.notes; if(obj.trainText)trainText=obj.trainText; saveAll(); boot(); toast('å¯¼å…¥å®Œæˆ') }catch{ toast('å¯¼å…¥å¤±è´¥ï¼šJSON æœ‰è¯¯') } });
$('wipeAll')?.addEventListener('click',()=>{ if(!confirm('æ¸…ç©ºæœ¬åœ°æ•°æ®ï¼Ÿä¸å¯æ¢å¤'))return; Object.values(K).forEach(k=>localStorage.removeItem(k)); toast('å·²æ¸…ç©ºï¼Œåˆ·æ–°ä¸­â€¦'); setTimeout(()=>location.reload(),300) });
$('saveTimerPref')?.addEventListener('click',()=>{ prefs.interval=parseInt(($('intervalInput')?.value)||60,10); prefs.beepLen=parseInt(($('beepLen')?.value)||2,10); save(K.prefs,prefs); resetCountdown(); toast('è®¡æ—¶è®¾ç½®å·²ä¿å­˜') });

/* ====== äº‘ç«¯å·¥å…·æ¡ç»‘å®š ====== */
$('btnPing')?.addEventListener('click', async()=>{ try{ const t=await cloudPing(); setDot(true); toast('âœ… '+t); $('btnLoad').disabled=false; $('btnSave').disabled=false; }catch{ setDot(false); toast('âŒ æ— æ³•è¿æ¥äº‘ç«¯') } });
$('btnVerify')?.addEventListener('click', async()=>{ try{ const r=await fetch(WORKER_URL+'/__who'); const j=await r.json(); setDot(!!j.has_STORE); toast('STORE='+(j.has_STORE?'âœ…':'âŒ')+' Â· ak_sha_len='+(j.ak_sha_len||0)); }catch{ setDot(false); toast('æ— æ³•è·å– __who') } });
$('btnLoad')?.addEventListener('click', async()=>{ const remote=await cloudLoad(); if(remote){ ({brand=brand,prefs=prefs,videos=videos,logs=logs,notes=notes,trainText=trainText} = remote); saveAll(); boot(); } });
$('btnSave')?.addEventListener('click', async()=>{ await cloudSave(allPayload()); });

/* ====== å¯åŠ¨ ====== */
function boot(){
  const t=$('appTitle'); if(t) t.textContent=brand.title;
  document.documentElement.style.setProperty('--bg', brand.bg);
  renderHomeChoices(); renderCustomList(); renderWork(); renderVmPartOptions(); renderLogFilters(); renderLogs();
}
function init(){
  loadAll(); boot();
  // è‡ªåŠ¨æ¢æµ‹äº‘ç«¯ï¼šå¯ç”¨åˆ™è§£é”è¯»å†™
  setTimeout(async()=>{ try{ const r=await secureFetch(WORKER_URL+'/',{method:'GET',cache:'no-store'}); const ok=r.ok; setDot(ok); if(ok){ $('btnLoad').disabled=false; $('btnSave').disabled=false; } }catch{ setDot(false); } }, 120);
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); } else { init(); }
</script>

<div id="vmEditDlg" class="overlay hide">
  <div class="modal">
    <div class="sectionTitle" style="margin-top:0">ç¼–è¾‘è§†é¢‘ï¼ˆæ ‡é¢˜ / é“¾æ¥ / æ”¹å˜éƒ¨ä½ï¼‰</div>
    <div class="row">
      <div class="field"><label>æ ‡é¢˜</label><input id="vmEditTitle" type="text" placeholder="å¦‚ï¼šæ·±è¹²åŠ¨ä½œè®²è§£"></div>
      <div class="field"><label>é“¾æ¥</label><input id="vmEditUrl" type="text" placeholder="https://â€¦ï¼ˆYouTube/MP4/é“¾æ¥ï¼‰"></div>
      <div class="field"><label>éƒ¨ä½</label><select id="vmEditPart"></select></div>
    </div>
    <div class="actions">
      <button class="btn light" id="vmEditCancel" type="button">å–æ¶ˆ</button>
      <button class="btn ok" id="vmEditSave" type="button">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
(function(){
  function normalize(t){ return (t||'').replace(/\s+/g,'').trim(); }
  function isEdit(t){ t=normalize(t); return t.includes('ç¼–è¾‘'); }
  function isDel(t){ t=normalize(t); return t.includes('åˆ é™¤'); }
  function tagRows(){
    var list = document.querySelector('#vmList');
    if(!list) return;
    Array.prototype.forEach.call(list.children, function(row){
      var btns = row.querySelectorAll('button, a');
      var edit=null, del=null;
      btns.forEach(function(b){
        var tx=(b.textContent||'').trim();
        if(!edit && isEdit(tx)) edit=b;
        if(!del  && isDel(tx))  del=b;
      });
      if(edit && del){
        row.classList.add('vm-list-item');
        edit.classList.add('vm-edit');
        del.classList.add('vm-del');
      }
    });
  }
  document.addEventListener('DOMContentLoaded', tagRows);
  setTimeout(tagRows, 400);
  setTimeout(tagRows, 1200);
  var obs = new MutationObserver(tagRows);
  obs.observe(document.body, {childList:true, subtree:true});
})();
</script>
</body>
</html>
