<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="theme-color" content="#2563eb"/>
<title>JasperGYM</title>
<style>
:root{--bg:#91C6FF;--panel:#fff;--ink:#0f172a;--muted:#64748b;--brand:#2563eb;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;--border:#d1d5db;--field:#fff}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC","Helvetica Neue",Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px 16px 140px}
/* 顶部：左侧云端 + 右侧导航（统一按钮） */
.header{padding:8px 0 6px}
.headerbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.leftgrp{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.appTitle{font-weight:800;font-size:22px}
.btnrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
/* 统一按钮外观（云端 + 导航 + 主要操作） */
.gbtn{appearance:none;background:#fff;color:#111;border:1px solid var(--border);border-radius:999px;padding:9px 16px;font-weight:700;cursor:pointer;line-height:1;height:40px;display:inline-flex;align-items:center;gap:6px}
.gbtn:hover{background:#f8fafc}.gbtn:active{transform:translateY(1px)}.gbtn[disabled]{opacity:.55;cursor:not-allowed}
/* 页面内操作按钮：统一到与保存注意事项相同的轻量尺寸 */
.btn{border:none;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer;font-size:14px;line-height:1;height:40px}
.btn.brand{background:var(--brand);color:#fff}.btn.ok{background:var(--ok);color:#fff}.btn.warn{background:var(--warn);color:#fff}.btn.light{background:transparent;border:1px solid var(--border);color:#111}.btn.danger{background:var(--danger);color:#fff}
.btn.xs{height:32px;padding:6px 10px;font-size:12px;border-radius:10px}
/* 导航选中态 */
.navbtn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
/* 其它基础 */
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.sectionTitle{font-size:16px;font-weight:700;margin:0 0 12px}
.row{display:grid;gap:16px}.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
select,input[type=text],input[type=number],input[type=color],textarea{width:100%;background:var(--field);color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
textarea{min-height:140px;resize:vertical}.bigtext{min-height:300px}.bigtextx3{min-height:900px}
.muted{color:var(--muted)}.tiny{font-size:12px}.hide{display:none}
/* 首页 */
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.choice{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:12px;padding:12px;cursor:pointer}
.choice input{transform:scale(1.2)}.choice:hover{border-color:var(--brand)}.choice .name{font-weight:700}
.customOps{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.customTag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:6px 10px;border-radius:999px}
/* 训练 */
.timerGrid{display:grid;grid-template-columns:1fr 160px;gap:12px;align-items:center}
.timer{font-size:36px;font-weight:800;letter-spacing:1px}
.timerBtns{display:flex;flex-direction:column;gap:8px}.timerBtns .btn{width:100%}
#videoContainer{width:100%;height:640px;background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
#videoIframe,#videoHtml5{width:100%;height:100%;border:0;display:none}#videoFallback{display:none;color:#fff;padding:12px}
/* 日志 */
.filterRow,.toolsRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.log-item{padding:16px 10px;border-bottom:1px solid var(--border);border-radius:8px;margin-bottom:10px}
.log-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.log-title{font-weight:700;cursor:pointer;margin-bottom:6px}.log-tags{font-size:12px;color:#64748b;margin-left:auto}
.log-content{margin-top:6px;white-space:pre-wrap;word-break:break-word;line-height:1.8}
.editBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
/* 云端状态点 */
.dot{width:10px;height:10px;border-radius:50%;background:#d1d5db;border:1px solid #94a3b8}
#cloudText{font-size:12px;color:var(--muted)}

/* —— 只隐藏按钮外观，功能仍保留 —— */
.hide-btn{display:none !important}
/* 统一顶部按钮高度，避免“高低不齐” */
.gbtn,.pill{height:40px;line-height:40px}

/* 日志富媒体展示 + 复制条（最小样式） */
.log-media{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.log-media img{max-height:120px;border-radius:8px;border:1px solid var(--border)}
.log-copybar{display:flex;justify-content:flex-end;margin-top:8px}

/* === 按钮对齐（极小范围） === */
#refVideoRow{display:grid;grid-template-columns:1fr 360px;gap:12px;align-items:center}
#refVideoRow .field select,#refVideoRow #openVideo.gbtn{height:40px;line-height:40px}
#refVideoRow #openVideo.gbtn{width:100%;display:flex;align-items:center;justify-content:center}

#page-settings .row.auto{align-items:center}
#page-settings .row.auto .btn.ok{height:40px;line-height:40px}

/* 手机 */
@media (max-width: 900px){
  #refVideoRow{grid-template-columns:1fr}
}

/* 设置卡片内：行内垂直居中 & 按钮等高 */
.card .sectionTitle + .row.auto{align-items:center}
.card .sectionTitle + .row.auto .btn.ok{height:40px;line-height:40px}

/* 精准缩小按钮内边距，避免看起来比输入框高（仅作用于这两处） */
#refVideoRow #openVideo.gbtn,
.card .sectionTitle + .row.auto .btn.ok{
  padding-top:0!important;padding-bottom:0!important;
}

/* --- settings rows precise tune --- */
#timerRow, #brandRow { align-items:center; }
#timerRow .btn.ok, #brandRow .btn.ok{
  height:36px !important; line-height:36px !important; padding-top:0!important; padding-bottom:0!important;
}
#timerRow .field > label, #brandRow .field > label{ margin-bottom:6px; } /* keep label spacing consistent */

/* === VM区行对齐：textarea 与“添加/更新”同右边界 === */
#vmRowTop{display:grid;grid-template-columns:1fr 1fr 1fr 140px;gap:12px;align-items:end}
#vmRowNotes{display:grid;grid-template-columns:1fr 1fr 1fr 140px;gap:12px;align-items:start}
#vmRowNotes .field.notes{grid-column:1 / span 3}
#vmRowTop .btn.ok,#vmRowNotes .btn.ok{height:36px;line-height:36px;padding-top:0;padding-bottom:0}

/* === 精准：只作用首页与设置页的 row.auto === */
#page-home .row.auto, #page-settings .row.auto { align-items: center; }
#page-home .row.auto .gbtn, #page-home .row.auto .btn.ok,
#page-settings .row.auto .gbtn, #page-settings .row.auto .btn.ok {
  height:40px !important; line-height:40px !important; padding-top:0!important; padding-bottom:0!important;
}

/* === Jasper 修正：统一对齐与移动端适配（来自用户给定规范） === */
/* 修复训练页进入按钮对齐 */
#page-home .row.auto.vm-notes {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: center;
}
/* 修复设置页视频管理区域对齐 */
#vmRowTop, #vmRowNotes {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr auto;
  gap: 12px;
  align-items: end;
}
#vmRowNotes .field.notes { grid-column: 1 / span 3; }
/* 统一设置页所有操作按钮高度 */
#page-settings .row.auto { align-items: end; }
#page-settings .row.auto .btn,
#page-settings .row.auto .gbtn {
  height: 40px;
  line-height: 40px;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
}
/* 修复倒计时设置区域 */
#timerRow, #brandRow {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 12px;
  align-items: end;
}
/* 修复数据管理按钮区域 */
#page-settings .card:last-child .row.auto {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}
#page-settings .card:last-child .row.auto .btn {
  flex: 1;
  min-width: 200px;
  height: 40px;
  line-height: 40px;
}
/* 移动端适配 */
@media (max-width: 900px) {
  #page-home .row.auto.vm-notes,
  #vmRowTop, #vmRowNotes,
  #timerRow, #brandRow {
    grid-template-columns: 1fr;
    align-items: stretch;
  }
  #page-settings .card:last-child .row.auto .btn { min-width: 100%; }
  #vmRowNotes .field.notes { grid-column: 1; }
}

/* === 简洁编辑对话框（仅用于“视频编辑：标题/链接/改变部位”） === */
/* 保证初始隐藏：避免 .overlay 的 display 覆盖掉 .hide */
.overlay.hide{display:none!important}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;max-width:540px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal .row{display:grid;gap:12px}
.modal .row.auto{grid-template-columns:1fr 1fr}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

/* ===== JASPER FIXED8 ===== */
/* 1) 隐藏 JGym 标题 */
#appTitle, .appTitle { display: none !important; }

/* 2) 让两组按钮并排一排（不换行，超出可横向滚动） */
.headerbar { 
  display: flex !important;
  flex-wrap: nowrap !important;
  justify-content: center !important;
  align-items: center !important;
  gap: 10px !important;
  overflow-x: auto;
}
.leftgrp, .btnrow, #tabs {
  display: flex !important;
  flex-wrap: nowrap !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 10px !important;
  margin: 0;
  padding: 0;
}

/* 3) 保留 8 个按钮：隐藏云端状态（文本与圆点） */
#cloudText, #cloudDot { display: none !important; }

/* 4) 按钮统一尺寸（沿用你之前的规格） */
#btnLoad, #btnSave, #btnReadJson, #btnSaveJson,
#tabs .gbtn {
  height: 44px !important;
  min-width: 120px !important;
  width: 120px !important;
  border-radius: 999px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  padding: 0 14px !important;
  line-height: 1 !important;
}
/* ===== END FIXED8 ===== */

/* ===== JASPER FIXED9 ===== */
/* 视频列表：编辑与删除按钮右对齐，间距 10px */
.vm-list-item {
  display: grid !important;
  grid-template-columns: 1fr auto auto !important;
  align-items: center !important;
  column-gap: 10px !important;
}
.vm-edit, .vm-del {
  justify-self: end !important;
  display: inline-flex !important;
  align-items: center !important;
  height: 32px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
}
.vm-edit { margin-right: 10px !important; }
.vm-del { margin-left: 10px !important; }
/* ===== END FIXED9 ===== */

/* ===== JASPER FIXED10 ===== */
/* Grid row with right-aligned edit/delete and 10px gap */
.vm-list-item {
  display: grid !important;
  grid-template-columns: 1fr auto auto !important;
  align-items: center !important;
  column-gap: 10px !important;
  width: 100%;
}
.vm-edit, .vm-del {
  justify-self: end !important;
  display: inline-flex !important;
  align-items: center !important;
  height: 32px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
}
.vm-edit { margin-right: 10px !important; }
.vm-del  { margin-left: 10px !important; }
/* ===== END FIXED10 ===== */

/* ===== JASPER FIXED11 ===== */
/* 确保列表容器为块级，子项一行一个 */
#vmList { display: block !important; }
#vmList > * { display: block !important; width: 100% !important; }

/* 每行布局：标题在左，按钮在最右，按钮间距10px */
#vmList > .vm-list-item {
  display: grid !important;
  grid-template-columns: 1fr auto auto !important;
  align-items: center !important;
  column-gap: 10px !important;
}
#vmList > .vm-list-item .vm-edit,
#vmList > .vm-list-item .vm-del {
  justify-self: end !important;
  display: inline-flex !important;
  align-items: center !important;
  height: 32px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
}
#vmList > .vm-list-item .vm-edit { margin-right: 10px !important; }
#vmList > .vm-list-item .vm-del  { margin-left: 10px !important; }
/* ===== END FIXED11 ===== */

/* ===== JASPER FIXED12 ===== */
/* 保证每个视频独立一行，编辑与删除按钮之间固定5px间距 */
#vmList { display: block !important; }
#vmList > * { display: block !important; width: 100% !important; }

#vmList > .vm-list-item {
  display: grid !important;
  grid-template-columns: 1fr auto auto !important;
  align-items: center !important;
  column-gap: 5px !important;
}

#vmList > .vm-list-item .vm-edit,
#vmList > .vm-list-item .vm-del {
  justify-self: end !important;
  display: inline-flex !important;
  align-items: center !important;
  height: 32px !important;
  padding: 0 10px !important;
  border-radius: 999px !important;
}

#vmList > .vm-list-item .vm-edit { margin-right: 5px !important; }
#vmList > .vm-list-item .vm-del  { margin-left: 5px !important; }
/* ===== END FIXED12 ===== */

/* === Jasper：统一顶部 9 个按钮尺寸（不改布局/逻辑） === */
#btnLoad, #btnSave, #btnReadJson, #btnSaveJson,
#tabs .gbtn {
  height: 44px !important;
  min-width: 120px !important;
  width: 120px !important;
  border-radius: 999px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  padding: 0 14px !important;
  line-height: 1 !important;
}

/* ===== JASPER FIXED17: 手机端两排按钮统一等分 ===== */
@media (max-width: 768px){
  /* 整体头部竖排 */
  .headerbar{
    display: grid !important;
    grid-template-columns: 1fr !important;
    row-gap: 12px !important;
    justify-items: center !important;
  }
  
  /* 两排按钮容器：4列等分网格 */
  .leftgrp, #tabs{
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    column-gap: 10px !important;
    row-gap: 10px !important;
    width: 100% !important;
    justify-items: stretch !important;
  }
  
  /* 统一所有8个按钮样式 */
  #btnLoad, #btnSave, #btnReadJson, #btnSaveJson,
  #tabs .gbtn{
    width: 100% !important;
    min-width: 0 !important;
    height: 44px !important;
    border-radius: 999px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    white-space: nowrap !important;
    font-weight: 700 !important;
    font-size: 14px !important;
    line-height: 1 !important;
    padding: 0 10px !important;
    text-align: center !important;
  }
  
  /* 隐藏状态元素 */
  #cloudDot, #cloudText{ display:none !important; }
}
/* ===== END FIXED17 ===== */

/* ===== 训练页按钮统一大小 ===== */
#btnStartTimer, #btnStopTimer, #btnResetTimer {
  height: 44px !important;
  border-radius: 999px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  line-height: 1 !important;
  padding: 0 16px !important;
  min-width: 120px !important;
}

/* 训练页其他主要按钮统一 */
#btnEditTrain, #btnSaveTrain, #btnCancelTrain,
#btnStart {
  height: 44px !important;
  border-radius: 999px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 700 !important;
  padding: 0 16px !important;
  min-width: 120px !important;
}

</style>

<!-- 🔹 Favicon & PWA -->
<link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
<link rel="manifest" href="favicon_io/site.webmanifest">
<link rel="shortcut icon" href="favicon_io/favicon.ico">
<meta name="theme-color" content="#4285f4">

</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="headerbar">
      <!-- 左侧：标题 + 云端 -->
      <div class="leftgrp">
        <div class="appTitle" id="appTitle">JasperGYM</div>
        <div class="btnrow">
          <button class="gbtn" id="btnVerify">验证云端</button>
          <button class="gbtn" id="btnPing">云端连接</button>
          <button class="gbtn" id="btnLoad" disabled>云端读取</button>
          <button class="gbtn" id="btnSave" disabled>云端保存</button>
          <button class="gbtn" id="btnReadJson">读取JSON</button>
          <button class="gbtn" id="btnSaveJson">保存JSON</button>
          <input type="file" id="jsonFilePicker" class="hide" accept=".json"/>
          <span class="dot" id="cloudDot"></span>
          <span id="cloudText" class="tiny">未连接</span>
        </div>
      </div>
      <!-- 右侧：与云端按钮同样大小的导航按钮 -->
      <div class="btnrow" id="tabs">
        <button class="gbtn navbtn active" data-page="home">🏠 首页</button>
        <button class="gbtn navbtn" data-page="work">💪 训练</button>
        <button class="gbtn navbtn" data-page="logs">📘 日志</button>
        <button class="gbtn navbtn" data-page="settings">⚙️ 设置</button>
      </div>
    </div>
  </div>

  <!-- 首页 -->
  <div id="page-home">
    <div class="card">
      <div class="sectionTitle">今天训练什么？</div>
      <div class="choices" id="homeChoices"></div>
      <div class="row auto vm-notes" id="vmRowNotes" style="margin-top:10px">
        <div class="tiny muted">选择后点击开始；“设置→视频管理”维护各部位的视频与注意事项。</div>
        <button class="btn brand" id="btnStart" type="button">进入训练页</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn light" id="btnManageCustom" type="button">管理自定义</button>
        <div id="customMgr" class="hide card" style="margin:10px 0 0">
          <div class="row auto">
            <div class="field"><label>新增自定义部位</label>
              <input id="newCustomName" type="text" placeholder="如：小腿、臀外侧…">
            </div>
            <button class="btn ok" id="addCustom" type="button">添加</button>
          </div>
          <div id="customList" class="customOps"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 训练 -->
  <div id="page-work" class="hide">
    <div class="card">
      <div class="sectionTitle">本次训练</div>
      <div class="row auto">
        <div class="field"><label>训练部位</label><select id="workPart"></select></div>
      </div>
      <div class="timerGrid card" style="margin-top:10px">
        <div class="timer" id="timer">00:00</div>
        <div class="timerBtns">
          <button class="btn ok" id="btnStartTimer" type="button">开始倒计时</button>
          <button class="btn light" id="btnStopTimer" type="button">停止</button>
          <button class="btn light" id="btnResetTimer" type="button">重置</button>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="sectionTitle" style="margin:0">训练记录</div>
          <div class="editBar">
            <button id="btnEditTrain" class="btn light" type="button">编辑</button>
            <button id="btnSaveTrain" class="btn ok hide" type="button">保存</button>
            <button id="btnCancelTrain" class="btn light hide" type="button">取消</button>
          </div>
        </div>
        <div id="trainView" class="notice">暂无记录</div>
        <textarea id="trainEdit" class="bigtextx3 hide" placeholder="在此编辑训练记录…"></textarea>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">参考视频</div>
      <div class="row auto" id="refVideoRow">
        <div class="field"><label>选择视频</label><select id="videoSelect"></select></div>
        <div class="field"><label>&nbsp;</label><a id="openVideo" class="gbtn" style="text-decoration:none" target="_blank" href="#">打开视频</a></div>
      </div>
      <div id="videoContainer" style="margin-top:8px">
        <iframe id="videoIframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        <video id="videoHtml5" controls></video>
        <div id="videoFallback" class="tiny">暂无视频</div>
      </div>
      <div class="notice" id="partNotice">暂无注意事项</div>
    </div>
  </div>

  <!-- 日志 -->
  <div id="page-logs" class="hide">
    <div class="card">
      <div class="sectionTitle">训练日志</div>
      <div class="filterRow"><label>筛选部位</label><select id="logFilter"></select></div>
      <div class="toolsRow">
        <button class="btn ok" id="toggleAddLog" type="button">➕ 添加日志</button>
        <button class="btn light" id="toggleSort" type="button">✏️ 编辑/排序</button>
        <button class="btn light" id="toggleOrder" type="button">显示顺序：自定义</button>
      </div>
      <div id="addEditBox" class="hide card" style="margin-top:0">
        <div class="row auto">
          <div class="field"><label>部位</label><select id="logPart"></select></div>
          <div class="field"><label>标题</label><input id="editTitle" type="text" placeholder="第一行会作为标题，可在此重写"></div>
          <div class="field" style="grid-column:1/-1"><label>视频链接（可空格分隔多个）</label><input id="editMediaLinks" type="text" placeholder="例如： https://youtu.be/... https://example.com/xxx.jpg"></div>
          <div class="field" style="grid-column:1/-1"><label>日志内容</label><textarea id="editContent" class="bigtext" placeholder="正文（支持多段落）"></textarea></div>
        </div>
        <div class="row auto">
          <button class="btn ok" id="saveLog" type="button">保存</button>
          <button class="btn light" id="cancelEdit" type="button">取消</button>
        </div>
      </div>
      <div id="logList" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- 设置 -->
  <div id="page-settings" class="hide">
    <div class="card">
      <div class="sectionTitle" id="vmTitle">（选择部位）视频 & 注意事项</div>
      <div class="row auto vm-top" id="vmRowTop">
        <div class="field"><label>部位</label><select id="vmPart"></select></div>
        <div class="field"><label>名称</label><input id="vmName" type="text" placeholder="如：深蹲动作讲解"></div>
        <div class="field"><label>链接</label><input id="vmUrl" type="text" placeholder="https://…（YouTube/MP4/链接）"></div>
        <div class="field"><label>&nbsp;</label><button class="btn ok" id="vmAdd" type="button">添加/更新</button></div>
      </div>
      <div class="row auto vm-notes" id="vmRowNotes" style="margin-top:10px">
        <div class="field notes"><label>该部位「训练注意事项」</label><textarea id="vmNotes" placeholder="要点/发力/常见错误… 一行一条亦可"></textarea></div>
        <div class="field"><label>&nbsp;</label><button class="btn ok" id="saveNotes" type="button">保存注意事项</button></div>
      </div>
      <div id="vmList" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <div class="sectionTitle">倒计时设置</div>
      <div class="row auto">
        <div class="field"><label>时间间隔（秒）</label><input id="intervalInput" type="number" min="10" max="999" step="1" value="60"/></div>
        <div class="field"><label>提示音长度（秒）</label><input id="beepLen" type="number" min="1" max="10" step="1" value="2"/></div>
        <div class="field"><label>&nbsp;</label><button class="btn ok" id="saveTimerPref" type="button">保存计时设置</button></div>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">外观 / 标识</div>
      <div class="row auto">
        <div class="field"><label>自定义标题</label><input id="titleInput" type="text" placeholder="如：JasperGYM"></div>
        <div class="field"><label>版本号</label><input id="verInput" type="text" placeholder="如：v3.37b"></div>
        <div class="field"><label>背景颜色</label><input id="bgColor" type="color" value="#91C6FF"></div>
        <div class="field"><label>&nbsp;</label><button class="btn ok" id="saveBrand" type="button">保存外观</button></div>
      </div>
    </div>
    <div class="card">
      <div class="sectionTitle">数据管理</div>
      <div class="row auto">
        <button class="btn danger" id="wipeAll" type="button">🗑 清空全部数据（不可恢复）</button>
      </div>
    </div>
  </div>
</div>
<div id="toast" class="toast hide"></div>
<audio id="beepAudio" src="bell.mp3" preload="auto"></audio>

<script>
/* ====== 基础工具 ====== */
// === 操作确认：防误触 ===
[['btnLoad','确认从云端读取配置与数据？'],['btnSave','确认保存到云端？'],['btnReadJson','确认读取 JSON？（本地/网络）'],['btnSaveJson','确认导出/上传 JSON？'],['wipeAll','确定要清空全部数据？（不可恢复）']].forEach(([id,msg])=>{
  const el=document.getElementById(id);
  if(el){ el.addEventListener('click',(e)=>{ if(!window.confirm(msg)){ e.preventDefault(); e.stopImmediatePropagation(); } }, true); }
});

// === 媒体链接：从输入框解析为数组（空格分隔），保存到当前日志 ===
document.getElementById('saveLog')?.addEventListener('click', ()=>{
  setTimeout(()=>{
    const raw = (document.getElementById('editMediaLinks')?.value||'').trim();
    if(!raw) return;
    const links = raw.split(/\s+/).filter(Boolean);
    let idx = (typeof editingIndex!=='undefined' && editingIndex!==null) ? editingIndex : (logs.length-1);
    if(idx<0 || !logs[idx]) idx = logs.length-1;
    if(idx>=0 && logs[idx]){
      logs[idx].mediaLinks = links;
      // 兼容：移除旧的 photos / videoUrl
      delete logs[idx].photos;
      delete logs[idx].videoUrl;
      save('logs', logs);
      document.getElementById('editMediaLinks').value='';
      renderLogs();
    }
  }, 0);
});

// === 富媒体辅助 ===
function readFilesAsDataURLs(fileList){
  const files = Array.from(fileList||[]);
  return Promise.all(files.map(f => new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res({name:f.name, data: fr.result});
    fr.onerror = rej; fr.readAsDataURL(f);
  })));
}
// 在原 saveLog 执行后，补写 videoUrl / photos，再保存并重渲染
document.getElementById('saveLog')?.addEventListener('click', ()=>{
  setTimeout(async ()=>{
    try{
      const vEl = document.getElementById('editVideo');
      const pEl = document.getElementById('editPhotos');
      const videoUrl = vEl ? (vEl.value||'').trim() : '';
      let photos = [];
      if(pEl && pEl.files && pEl.files.length){ photos = await readFilesAsDataURLs(pEl.files); }
      if(!videoUrl && photos.length===0) return; // 没有新增媒体则不改
      // 推断当前索引（新增=最后一条；编辑=editingIndex）
      let idx = (typeof editingIndex!=='undefined' && editingIndex!==null) ? editingIndex : (logs.length-1);
      if(idx<0 || !logs[idx]) idx = logs.length-1;
      const old = logs[idx] || {};
      logs[idx] = {...old, videoUrl: videoUrl || old.videoUrl || '', photos: (photos.length? photos : (Array.isArray(old.photos)?old.photos:[]))};
      if(typeof save==='function') save(K.logs, logs);
      if(typeof renderLogs==='function') renderLogs();
    }catch(e){ console.error('augment media failed', e); }
  }, 0);
});

/* AUTO_HIDE_CLOUD_BTNS: 在不破坏功能的前提下隐藏“验证云端/云端连接”，并自动触发它们 */
function _safe(el){return typeof el==='string'?document.getElementById(el):el}
function _hideBtn(id){const b=_safe(id); if(b){ b.classList.add('hide-btn'); }}
function _autoClick(id){const b=_safe(id); if(b){ try{ b.click(); }catch(e){} }}
window.addEventListener('DOMContentLoaded',()=>{
  _hideBtn('btnVerify'); _hideBtn('btnPing');             // 仅隐藏外观
  setTimeout(()=>{ _autoClick('btnVerify'); _autoClick('btnPing'); }, 300); // 保持原有逻辑
});
/* JSON 读写（并行存在，不影响云端逻辑） */
function _downloadJson(name, obj){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=name||'jaspergym-data.json'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1200);
}
async function _fetchJson(url){
  const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
}
document.getElementById('btnReadJson')?.addEventListener('click', async ()=>{
  const mode=prompt('输入 URL 从网络读取；留空则从本地选择文件','');
  if(mode && mode.trim()){
    try{
      const j=await _fetchJson(mode.trim());
      if(j.brand) brand=j.brand; if(j.prefs) { prefs=j.prefs; try{ prefs.part='全部'; }catch(e){} } if(j.videos) videos=j.videos;
      if(j.logs) logs=j.logs; if(j.notes) notes=j.notes; if(j.trainText) trainText=j.trainText;
      saveAll(); if(typeof boot==='function') boot(); if(typeof renderLogs==='function') renderLogs();
      prefs && (prefs.part = '全部'); saveAll && saveAll();
toast('✅ 已从网络 JSON 导入');
setTimeout(()=>{ 
  try{ 
    if(typeof renderLogFilters==='function') renderLogFilters();
    if(typeof renderLogs==='function') renderLogs();
    if(typeof refreshUI==='function') refreshUI();
    if(typeof boot==='function') boot();
  }catch(e){ console.error(e); }
}, 200);
    }catch(e){ toast('❌ 拉取失败：'+e.message); }
  
  } else {
    // 使用临时文件选择器，避免 display:none 导致的点击被拦截
    const picker = document.createElement('input');
    picker.type = 'file';
    picker.accept = '.json,application/json';
    picker.style.position = 'fixed';
    picker.style.left = '-9999px';
    document.body.appendChild(picker);
    picker.onchange = async ()=>{
      try{
        const file = picker.files && picker.files[0];
        if(!file){ document.body.removeChild(picker); return; }
        const txt = await file.text();
        const j = JSON.parse(txt);
        if(j.brand) brand=j.brand; if(j.prefs) { prefs=j.prefs; try{ prefs.part='全部'; }catch(e){} } if(j.videos) videos=j.videos;
        if(j.logs) logs=j.logs; if(j.notes) notes=j.notes; if(j.trainText) trainText=j.trainText;
        if(typeof saveAll==='function') saveAll();
        if(typeof boot==='function') boot();
        if(typeof renderLogs==='function') renderLogs();
        prefs && (prefs.part = '全部'); saveAll && saveAll();
toast('✅ 已从本地 JSON 导入');
setTimeout(()=>{ 
  try{ 
    if(typeof renderLogFilters==='function') renderLogFilters();
    if(typeof renderLogs==='function') renderLogs();
    if(typeof refreshUI==='function') refreshUI();
    if(typeof boot==='function') boot();
  }catch(e){ console.error(e); }
}, 200);
      }catch(e){
        console.error('JSON import error:', e);
        toast('❌ 解析失败：'+e.message);
      }finally{
        document.body.removeChild(picker);
      }
    };
    picker.click();
  }

});
document.getElementById('btnSaveJson')?.addEventListener('click', async ()=>{
  const url=prompt('留空=直接下载；如需网络保存请输入接收 JSON 的 URL（支持 PUT/POST）','');
  const payload=typeof allPayload==='function'?allPayload():{brand,prefs,videos,logs,notes,trainText};
  if(!url){ _downloadJson('jaspergym-data.json', payload); toast('⬇️ 已导出为文件'); return; }
  try{
    let r=await fetch(url,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('HTTP '+r.status); }
    toast('✅ 已上传到网络 URL');
  }catch(e){ toast('❌ 网络保存失败：'+e.message); }
});

const $=id=>document.getElementById(id);
const toast=t=>{const e=$('toast');if(!e)return; e.textContent=t;e.classList.remove('hide');e.style.opacity=1;setTimeout(()=>e.style.opacity=0,1600);setTimeout(()=>e.classList.add('hide'),2000)};
const setDot=(ok)=>{const d=$('cloudDot'); if(d) d.style.background=ok?'#10b981':'#ef4444'; const t=$('cloudText'); if(t) t.textContent=ok?'云端已连接':'离线'};

/* ====== 云端（XHS 接法，写死 URL/Key） ====== */
const WORKER_URL='https://gym.sevenoy.workers.dev';
const ACCESS_KEY='jiajia11';
async function timedFetch(url,opts,ms){const ctl=new AbortController();const to=setTimeout(()=>ctl.abort(),ms||12000);try{const r=await fetch(url,{signal:ctl.signal,...(opts||{})});clearTimeout(to);return r}catch(e){clearTimeout(to);throw e}}
async function secureFetch(url,opts){const headers=Object.assign({},(opts&&opts.headers)||{}, {'X-Access-Key':ACCESS_KEY});return timedFetch(url,{...(opts||{}),headers},12000)}
async function cloudPing(){const r=await timedFetch(WORKER_URL+'/ping'); return r.text()}
async function cloudLoad(){try{const r=await secureFetch(WORKER_URL+'/',{method:'GET',cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); const j=await r.json(); setDot(true); toast('✅ 已从云端读取'); return j}catch(e){ setDot(false); toast('❌ 云端读取失败'); return null }}
async function cloudSave(payload){try{const r=await secureFetch(WORKER_URL+'/',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('HTTP '+r.status); setDot(true); toast('✅ 已保存到云端'); return true}catch(e){ setDot(false); toast('❌ 云端保存失败'); return false }}

/* ====== 本地数据结构（与你旧版一致） ====== */
const K={brand:'gym_brand',prefs:'gym_prefs',videos:'gym_videos',logs:'gym_logs',notes:'gym_notes',trainText:'gym_traintext'};
let brand={title:'JasperGYM',ver:'',bg:'#91C6FF'};
let prefs={interval:60,beepLen:2,part:'legs',customParts:[],logOrder:'custom'};
let videos={legs:[],chest:[],back:[],arms:[],shoulders:[],core:[]};
let notes={legs:'',chest:'',back:'',arms:'',shoulders:'',core:''};
let trainText={};
let logs=[];

const load=(k,d)=>{try{const t=localStorage.getItem(k);return t?JSON.parse(t):d}catch{return d}};
const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
const loadAll=()=>{ brand=load(K.brand,brand); prefs=load(K.prefs,prefs); videos=load(K.videos,videos); logs=load(K.logs,logs); notes=load(K.notes,notes); trainText=load(K.trainText,trainText); };
const saveAll=()=>{ save(K.brand,brand); save(K.prefs,prefs); save(K.videos,videos); save(K.logs,logs); save(K.notes,notes); save(K.trainText,trainText); };
const allPayload=()=>({brand,prefs,videos,logs,notes,trainText});

/* ====== 导航 ====== */
function setActive(page){['home','work','logs','settings'].forEach(p=>$('page-'+p)?.classList.add('hide')); $('page-'+page)?.classList.remove('hide'); document.querySelectorAll('.navbtn').forEach(el=>el.classList.remove('active')); document.querySelector(`.navbtn[data-page="${page}"]`)?.classList.add('active'); if(page==='work'){ renderWork() } if(page==='logs'){ renderLogFilters(); renderLogs(); }}
$('tabs')?.addEventListener('click',e=>{const el=e.target.closest('.navbtn'); if(el&&el.dataset.page) setActive(el.dataset.page)});
$('btnStart')?.addEventListener('click',()=>setActive('work'));

/* ====== 首页 & 自定义 ====== */
const baseParts=[{id:'legs',name:'腿部'},{id:'chest',name:'胸部'},{id:'back',name:'背部'},{id:'arms',name:'手臂'},{id:'shoulders',name:'肩部'},{id:'core',name:'核心'}];
const allParts=()=>[...baseParts,...(prefs.customParts||[]).map(n=>({id:'c_'+encodeURIComponent(n),name:n}))];
const partName=id=>(allParts().find(p=>p.id===id)||{name:'未命名'}).name;
const ensureBucket=id=>{ if(!videos[id]) videos[id]=[]; if(!notes[id]) notes[id]=''; if(!trainText[id]) trainText[id]={all:''}; };
function renderHomeChoices(){ const box=$('homeChoices'); if(!box) return; box.innerHTML=''; baseParts.forEach(p=>box.appendChild(choice(p))); (prefs.customParts||[]).forEach(n=>box.appendChild(choice({id:'c_'+encodeURIComponent(n),name:n}))); const add=document.createElement('div'); add.className='choice'; add.innerHTML='<input type="radio" disabled/><span class="name">自定义</span>'; add.onclick=()=>{ $('btnManageCustom')?.click(); $('newCustomName')?.focus(); }; box.appendChild(add)}
function choice(p){ const d=document.createElement('div'); d.className='choice'; d.innerHTML='<input type="radio" name="part" '+(prefs.part===p.id?'checked':'')+'/><span class="name">'+p.name+'</span>'; d.onclick=()=>{prefs.part=p.id; save(K.prefs,prefs)}; return d }
$('btnManageCustom')?.addEventListener('click',()=>$('customMgr')?.classList.toggle('hide'));
$('addCustom')?.addEventListener('click',()=>{ const name=($('newCustomName')?.value||'').trim(); if(!name) return toast('请输入名称'); if((prefs.customParts||[]).includes(name)) return toast('已存在'); (prefs.customParts=prefs.customParts||[]).push(name); save(K.prefs,prefs); $('newCustomName').value=''; const id='c_'+encodeURIComponent(name); ensureBucket(id); saveAll(); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已添加') });
function renderCustomList(){ const box=$('customList'); if(!box) return; box.innerHTML=''; (prefs.customParts||[]).forEach((name,idx)=>{ const id='c_'+encodeURIComponent(name); const tag=document.createElement('div'); tag.className='customTag'; const nm=document.createElement('span'); nm.textContent=name; const edit=document.createElement('button'); edit.className='btn xs light'; edit.textContent='重命名'; const del=document.createElement('button'); del.className='btn xs danger'; del.textContent='删除'; edit.onclick=()=>{ const nn=prompt('重命名为：',name); if(!nn||!nn.trim())return; if(prefs.customParts.includes(nn.trim())) return toast('已存在'); const newId='c_'+encodeURIComponent(nn.trim()); videos[newId]=videos[id]||[]; notes[newId]=notes[id]||''; trainText[newId]=trainText[id]||{all:''}; delete videos[id]; delete notes[id]; delete trainText[id]; prefs.customParts[idx]=nn.trim(); if(prefs.part===id) prefs.part=newId; saveAll(); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已重命名') }; del.onclick=()=>{ if(!confirm('删除该自定义部位？'))return; prefs.customParts.splice(idx,1); delete videos[id]; delete notes[id]; delete trainText[id]; if(prefs.part===id) prefs.part='legs'; saveAll(); renderHomeChoices(); renderCustomList(); renderVmPartOptions(); toast('已删除') }; tag.appendChild(nm); tag.appendChild(edit); tag.appendChild(del); box.appendChild(tag) }) }

/* ====== 训练：计时/记录/视频 ====== */
let timerId=null,remain=0;
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const resetCountdown=()=>{ stopCountdown(); remain=parseInt(prefs.interval||60,10); const el=$('timer'); if(el) el.textContent=fmt(remain)};
const tick=()=>{ const el=$('timer'); if(!el) return; if(remain<=0){ stopCountdown(); beep(); return } el.textContent=fmt(remain--) };
function startCountdown(){ stopCountdown(); remain=parseInt(prefs.interval||60,10); $('timer').textContent=fmt(remain); tick(); timerId=setInterval(tick,1000) }
function stopCountdown(){ if(timerId){clearInterval(timerId);timerId=null} }
function beep(){ try{const a=document.getElementById('beepAudio'); if(!a) return; a.currentTime=0; a.play(); setTimeout(()=>a.pause(), (prefs.beepLen||2)*1000)}catch(e){} }
$('btnStartTimer')?.addEventListener('click',startCountdown);
$('btnStopTimer')?.addEventListener('click',stopCountdown);
$('btnResetTimer')?.addEventListener('click',resetCountdown);

function renderTrainView(){ ensureBucket(prefs.part); const v=(trainText[prefs.part]?.all)||''; const view=$('trainView'); if(view) view.textContent=v||'暂无记录'; const edit=$('trainEdit'); if(edit&&!edit.classList.contains('hide')) edit.value=v }
$('btnEditTrain')?.addEventListener('click',()=>{ ensureBucket(prefs.part); const edit=$('trainEdit'), view=$('trainView'); if(!edit||!view) return; edit.value=(trainText[prefs.part]?.all)||''; edit.classList.remove('hide'); view.classList.add('hide'); $('btnEditTrain').classList.add('hide'); $('btnSaveTrain').classList.remove('hide'); $('btnCancelTrain').classList.remove('hide') });
$('btnCancelTrain')?.addEventListener('click',()=>{ $('trainEdit')?.classList.add('hide'); $('trainView')?.classList.remove('hide'); $('btnEditTrain')?.classList.remove('hide'); $('btnSaveTrain')?.classList.add('hide'); $('btnCancelTrain')?.classList.add('hide') });
$('btnSaveTrain')?.addEventListener('click',()=>{ const edit=$('trainEdit'); if(!edit) return; ensureBucket(prefs.part); trainText[prefs.part].all=edit.value||''; save(K.trainText,trainText); renderTrainView(); $('trainEdit').classList.add('hide'); $('trainView').classList.remove('hide'); $('btnEditTrain').classList.remove('hide'); $('btnSaveTrain').classList.add('hide'); $('btnCancelTrain').classList.add('hide'); toast('训练记录已保存') });

const toYT=u=>{try{const x=new URL(u); if(x.hostname.includes('youtube.com')&&x.searchParams.get('v'))return`https://www.youtube.com/embed/${x.searchParams.get('v')}`; if(x.hostname.includes('youtu.be'))return`https://www.youtube.com/embed/${x.pathname.replace('/','')}`}catch{} return null};
function stopAllVideo(){ const iframe=$('videoIframe'),vid=$('videoHtml5'),fb=$('videoFallback'); try{vid&&vid.pause()}catch(e){} if(iframe) iframe.src=''; if(vid) vid.src=''; if(iframe) iframe.style.display='none'; if(vid) vid.style.display='none'; if(fb) fb.style.display='none' }
function previewVideo(url){ const iframe=$('videoIframe'),vid=$('videoHtml5'),fb=$('videoFallback'); stopAllVideo(); if(!url){ fb&&(fb.textContent='暂无视频',fb.style.display='block'); return } const yt=toYT(url); if(yt&&iframe){ iframe.src=yt; iframe.style.display='block'; return } if(/\.(mp4|webm|ogg)(\?.*)?$/i.test(url) && vid){ vid.src=url; vid.style.display='block'; return } fb&&(fb.textContent='此链接无法内嵌播放，请点击“打开视频”。',fb.style.display='block') }
function refreshVideoUI(partId){ ensureBucket(partId); const vs=$('videoSelect'); if(!vs) return; vs.innerHTML=''; const arr=videos[partId]||[]; if(!arr.length){ const o=document.createElement('option'); o.value=''; o.textContent='无视频'; vs.appendChild(o); previewVideo('') } else { arr.forEach((it,idx)=>{ const o=document.createElement('option'); o.value=idx; o.textContent=it.name; vs.appendChild(o) }); vs.value=0; previewVideo(arr[0].url) } vs.onchange=()=>{ const i=vs.value; if(i===''||i==null){previewVideo('');return} previewVideo((videos[partId]||[])[i].url) }; const a=document.getElementById('openVideo'); if(a) a.onclick=()=>{ const i=vs.value; if(i===''||i==null){toast('该部位暂无视频');return} window.open((videos[partId]||[])[i].url,'_blank') }; const pn=document.getElementById('partNotice'); if(pn) pn.textContent=notes[partId]||'暂无注意事项' }
function renderWork(){ const sel=$('workPart'); if(!sel) return; sel.innerHTML=''; allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id)) ); sel.value=prefs.part; ensureBucket(prefs.part); renderTrainView(); refreshVideoUI(prefs.part); resetCountdown(); sel.onchange=()=>{ prefs.part=sel.value; save(K.prefs,prefs); ensureBucket(prefs.part); renderTrainView(); refreshVideoUI(prefs.part); stopAllVideo(); } }

/* ====== 日志 ====== */
let sortMode=false,editingIndex=null;
function renderLogFilters(){ const sel=$('logFilter'); if(!sel) return; sel.innerHTML=''; sel.appendChild(new Option('全部','all')); allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id))); sel.onchange=renderLogs; const partSel=$('logPart'); if(partSel){ partSel.innerHTML=''; allParts().forEach(p=> partSel.appendChild(new Option(p.name,p.id))); partSel.value=prefs.part } }
$('toggleAddLog')?.addEventListener('click',()=>{ editingIndex=null; const t1=$('editTitle'); const t2=$('editContent'); const p=$('logPart'); if(t1) t1.value=''; if(t2) t2.value=''; if(p) p.value=prefs.part; $('addEditBox')?.classList.toggle('hide') });
$('cancelEdit')?.addEventListener('click',()=>$('addEditBox')?.classList.add('hide'));
$('saveLog')?.addEventListener('click',()=>{ const title=($('editTitle')?.value||'').trim(); const content=($('editContent')?.value||'').trim(); if(!title && !content) return toast('请至少填写标题或正文'); const pid=($('logPart')?.value)||prefs.part; const finalTitle=title || (content.split(/\r?\n/)[0]||'（无标题）'); const id=crypto.randomUUID?crypto.randomUUID():('id_'+Date.now()+Math.random()); if(editingIndex===null){ logs.push({id,title:finalTitle,content,part:pid,ts:Date.now()}); } else { logs[editingIndex]={...logs[editingIndex],title:finalTitle,content,part:pid}; } save(K.logs,logs); $('addEditBox')?.classList.add('hide'); renderLogs(); toast('已保存') });
$('toggleSort')?.addEventListener('click',()=>{ sortMode=!sortMode; renderLogs() });
$('toggleOrder')?.addEventListener('click',()=>{ prefs.logOrder=(prefs.logOrder==='custom'?'time':'custom'); save(K.prefs,prefs); renderLogs(); toast(prefs.logOrder==='custom'?'按自定义顺序显示':'按时间倒序显示'); });
function renderLogs(){ const box=$('logList'); if(!box) return; box.innerHTML=''; $('toggleOrder').textContent='显示顺序：'+(prefs.logOrder==='custom'?'自定义':'按时间'); const filter=($('logFilter')?.value)||'all'; let idxs=[]; for(let i=0;i<logs.length;i++){ if(filter==='all'||logs[i].part===filter) idxs.push(i) } const order = sortMode ? idxs : (prefs.logOrder==='time' ? [...idxs].sort((a,b)=> (logs[b].ts||0)-(logs[a].ts||0)) : idxs); if(!order.length){ box.innerHTML='<div class="tiny muted">暂无日志。</div>'; return } order.forEach((realIndex)=>{ const lg=logs[realIndex]; const item=document.createElement('div'); item.className='log-item'; const head=document.createElement('div'); head.className='log-head'; const title=document.createElement('div'); title.className='log-title'; title.textContent=lg.title||'（无标题）'; const tags=document.createElement('div'); tags.className='log-tags'; tags.textContent=partName(lg.part||''); head.appendChild(title); head.appendChild(tags); item.appendChild(head); const content=document.createElement('div'); content.className='log-content hide'; content.textContent=lg.content||'（无内容）'; title.onclick=()=>content.classList.toggle('hide'); item.appendChild(content);
    // 富媒体展示 + 复制内容按钮
    try{
      const media=document.createElement('div'); media.className='log-media';
      const mlinks = Array.isArray(lg.mediaLinks) ? lg.mediaLinks : [];
      if(mlinks.length){
        mlinks.forEach(u=>{ const s=(u||'').toLowerCase(); const isV = s.includes('youtube.com')||s.includes('youtu.be')||s.includes('vimeo.com')||s.endsWith('.mp4')||s.endsWith('.webm')||s.endsWith('.m3u8'); if(isV){ const a=document.createElement('a'); a.href=u; a.target='_blank'; a.textContent='▶ 打开视频'; media.appendChild(a);} else { const img=new Image(); img.src=u; img.alt='media'; media.appendChild(img);} });
      } else {
        if(lg.videoUrl){ const av=document.createElement('a'); av.href=lg.videoUrl; av.target='_blank'; av.textContent='▶ 打开视频'; media.appendChild(av); }
        if(Array.isArray(lg.photos)){
          lg.photos.forEach(ph=>{ const img=new Image(); img.src=ph.data||ph; img.alt=ph.name||'photo'; media.appendChild(img); });
        }
      }
      const copybar=document.createElement('div'); copybar.className='log-copybar';
      const cp=document.createElement('button'); cp.className='btn xs light'; cp.textContent='复制内容';
      cp.onclick=(e)=>{ e.stopPropagation(); const extra=(lg.videoUrl?'\n视频：'+lg.videoUrl:'') + (Array.isArray(lg.photos)&&lg.photos.length?'\n图片：'+lg.photos.map(p=>p.name||'img').join(', '):''); const txt=(lg.title||'')+'\n\n'+(lg.content||'')+extra; navigator.clipboard.writeText(txt).then(()=>alert('复制成功')).catch(()=>toast('复制失败')); };
      copybar.appendChild(cp);
      content.appendChild(media);
      content.appendChild(copybar);
    }catch(_){}
 if(sortMode){ const tools=document.createElement('div'); tools.className='toolsRow'; tools.innerHTML='<button class="btn xs light">⬆️ 上移</button><button class="btn xs light">⬇️ 下移</button><button class="btn xs light">✏️ 编辑</button><button class="btn xs danger">🗑 删除</button>'; const [upBtn,downBtn,editBtn,delBtn]=tools.querySelectorAll('button'); upBtn.onclick=(e)=>{e.stopPropagation(); moveInFiltered(filter, realIndex, -1) }; downBtn.onclick=(e)=>{e.stopPropagation(); moveInFiltered(filter, realIndex, +1) }; editBtn.onclick=(e)=>{e.stopPropagation(); editingIndex=realIndex; $('addEditBox')?.classList.remove('hide'); const p=$('logPart'); if(p) p.value=lg.part||prefs.part; const t1=$('editTitle'); const t2=$('editContent'); if(t1) t1.value=lg.title||''; if(t2) t2.value=lg.content||''; window.scrollTo({top:0,behavior:'smooth'}); }; delBtn.onclick=(e)=>{e.stopPropagation(); logs.splice(realIndex,1); save(K.logs,logs); renderLogs(); }; item.appendChild(tools); } box.appendChild(item) }) }
function moveInFiltered(filter, realIndex, delta){ const indices=[]; for(let i=0;i<logs.length;i++){ if(filter==='all'||logs[i].part===filter) indices.push(i) } const pos=indices.indexOf(realIndex); if(pos<0) return; const targetPos=pos+delta; if(targetPos<0||targetPos>=indices.length) return; const a=indices[pos], b=indices[targetPos]; [logs[a],logs[b]]=[logs[b],logs[a]]; save(K.logs,logs); renderLogs() }

/* ====== 设置/视频 ====== */
function renderVmPartOptions(){ const sel=$('vmPart'); if(!sel) return; sel.innerHTML=''; allParts().forEach(p=> sel.appendChild(new Option(p.name,p.id)) ); sel.value=prefs.part; const tit=$('vmTitle'); if(tit) tit.textContent=partName(sel.value)+' 视频 & 注意事项'; const n=$('vmNotes'); if(n) n.value=notes[sel.value]||''; renderVmList() }
$('vmPart')?.addEventListener('change',()=>{ const tit=$('vmTitle'); if(tit) tit.textContent=partName($('vmPart').value)+' 视频 & 注意事项'; const n=$('vmNotes'); if(n) n.value=notes[$('vmPart').value]||''; renderVmList() });
$('saveNotes')?.addEventListener('click',()=>{ const id=($('vmPart')?.value)||prefs.part; notes[id]=($('vmNotes')?.value)||''; save(K.notes,notes); if(prefs.part===id){ const pn=$('partNotice'); if(pn) pn.textContent=notes[id]||'' } toast('注意事项已保存') });
$('vmAdd')?.addEventListener('click',()=>{ const part=($('vmPart')?.value)||prefs.part, name=($('vmName')?.value||'').trim(), url=($('vmUrl')?.value||'').trim(); if(!name||!url) return toast('名称和链接都要填'); ensureBucket(part); const arr=videos[part]; const idx=arr.findIndex(x=>x.name===name); const item={name,url}; if(idx>=0) arr[idx]=item; else arr.push(item); save(K.videos,videos); $('vmName').value=''; $('vmUrl').value=''; renderVmList(); toast('已保存') });
function renderVmList(){ const part=($('vmPart')?.value)||prefs.part; ensureBucket(part); const box=$('vmList'); if(!box) return; box.innerHTML=''; const arr=videos[part]; if(!arr.length){ box.innerHTML='<div class="tiny muted">该部位暂无视频。</div>'; return } arr.forEach((it,idx)=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0'; row.style.borderBottom='1px solid var(--border)'; const left=document.createElement('div'); left.textContent=it.name; left.title=it.url; const right=document.createElement('div'); const edit=document.createElement('button'); edit.className='btn xs light'; edit.textContent='✏️ 编辑'; const del=document.createElement('button'); del.className='btn xs danger'; del.textContent='🗑 删除'; edit.onclick=()=>{ openVmEdit(part, idx); }; del.onclick=()=>{ arr.splice(idx,1); save(K.videos,videos); renderVmList(); }; right.appendChild(edit); right.appendChild(del); row.appendChild(left); row.appendChild(right); box.appendChild(row) }) }

/* === 设置页视频编辑对话框（支持改部位） === */
let vmEditCtx = { part: null, idx: -1 };
function openVmEdit(part, idx){
  ensureBucket(part);
  vmEditCtx = { part, idx };
  const it = (videos[part]||[])[idx] || {name:'', url:''};
  const t = document.getElementById('vmEditTitle');
  const u = document.getElementById('vmEditUrl');
  const p = document.getElementById('vmEditPart');
  if(p){ p.innerHTML=''; allParts().forEach(pp=> p.appendChild(new Option(pp.name, pp.id))); p.value = part; }
  if(t) t.value = it.name || '';
  if(u) u.value = it.url || '';
  const d = document.getElementById('vmEditDlg');
  if(d){ 
    d.classList.remove('hide');
    // 绑定按钮（在打开时绑定，确保元素已在DOM里）
    const cancelBtn = document.getElementById('vmEditCancel');
    const saveBtn   = document.getElementById('vmEditSave');
    if(cancelBtn) cancelBtn.onclick = ()=>{ document.getElementById('vmEditDlg')?.classList.add('hide'); };
    if(saveBtn)   saveBtn.onclick   = ()=>{
      const tval = (document.getElementById('vmEditTitle')?.value||'').trim();
      const uval = (document.getElementById('vmEditUrl')?.value||'').trim();
      const np   = (document.getElementById('vmEditPart')?.value)||vmEditCtx.part;
      if(!tval || !uval){ toast('标题和链接都要填'); return; }
      const op = vmEditCtx.part, i = vmEditCtx.idx;
      if(np === op){
        if(videos[op] && videos[op][i]) videos[op][i] = { name: tval, url: uval };
      }else{
        ensureBucket(np);
        const item = { name: tval, url: uval };
        if(videos[op]){ videos[op].splice(i, 1); }
        (videos[np] = videos[np] || []).push(item);
      }
      save(K.videos, videos);
      document.getElementById('vmEditDlg')?.classList.add('hide');
      renderVmList();
      if(prefs.part === vmEditCtx.part || prefs.part === np){
        try{ refreshVideoUI(prefs.part); }catch(_){}
      }
      toast('已保存');
    };
  }
}
// 允许按 ESC 关闭
window.addEventListener('keydown', (ev)=>{
  if(ev.key === 'Escape'){ document.getElementById('vmEditDlg')?.classList.add('hide'); }
});
/* ====== 外观/数据 ====== */

$('saveBrand')?.addEventListener('click',()=>{ brand.title=($('titleInput')?.value)||brand.title; brand.ver=($('verInput')?.value)||brand.ver; brand.bg=($('bgColor')?.value)||brand.bg; save(K.brand,brand); const t=$('appTitle'); if(t) t.textContent=brand.title; document.documentElement.style.setProperty('--bg', brand.bg); toast('外观已保存') });
$('exportAll')?.addEventListener('click',()=>{ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(allPayload(),null,2)); a.download='jaspergym-data.json'; a.click() });
$('importAll')?.addEventListener('click',()=>$('importFile')?.click());
$('importFile')?.addEventListener('change',async e=>{ const f=e.target.files[0]; if(!f) return; const text=await f.text(); try{ const obj=JSON.parse(text); if(obj.brand)brand=obj.brand; if(obj.prefs)prefs=obj.prefs; if(obj.videos)videos=obj.videos; if(obj.logs)logs=obj.logs; if(obj.notes)notes=obj.notes; if(obj.trainText)trainText=obj.trainText; saveAll(); boot(); toast('导入完成') }catch{ toast('导入失败：JSON 有误') } });
$('wipeAll')?.addEventListener('click',()=>{ if(!confirm('清空本地数据？不可恢复'))return; Object.values(K).forEach(k=>localStorage.removeItem(k)); toast('已清空，刷新中…'); setTimeout(()=>location.reload(),300) });
$('saveTimerPref')?.addEventListener('click',()=>{ prefs.interval=parseInt(($('intervalInput')?.value)||60,10); prefs.beepLen=parseInt(($('beepLen')?.value)||2,10); save(K.prefs,prefs); resetCountdown(); toast('计时设置已保存') });

/* ====== 云端工具条绑定 ====== */
$('btnPing')?.addEventListener('click', async()=>{ try{ const t=await cloudPing(); setDot(true); toast('✅ '+t); $('btnLoad').disabled=false; $('btnSave').disabled=false; }catch{ setDot(false); toast('❌ 无法连接云端') } });
$('btnVerify')?.addEventListener('click', async()=>{ try{ const r=await fetch(WORKER_URL+'/__who'); const j=await r.json(); setDot(!!j.has_STORE); toast('STORE='+(j.has_STORE?'✅':'❌')+' · ak_sha_len='+(j.ak_sha_len||0)); }catch{ setDot(false); toast('无法获取 __who') } });
$('btnLoad')?.addEventListener('click', async()=>{ const remote=await cloudLoad(); if(remote){ ({brand=brand,prefs=prefs,videos=videos,logs=logs,notes=notes,trainText=trainText} = remote); saveAll(); boot(); } });
$('btnSave')?.addEventListener('click', async()=>{ await cloudSave(allPayload()); });

/* ====== 启动 ====== */
function boot(){
  const t=$('appTitle'); if(t) t.textContent=brand.title;
  document.documentElement.style.setProperty('--bg', brand.bg);
  renderHomeChoices(); renderCustomList(); renderWork(); renderVmPartOptions(); renderLogFilters(); renderLogs();
}
function init(){
  loadAll(); boot();
  // 自动探测云端：可用则解锁读写
  setTimeout(async()=>{ try{ const r=await secureFetch(WORKER_URL+'/',{method:'GET',cache:'no-store'}); const ok=r.ok; setDot(ok); if(ok){ $('btnLoad').disabled=false; $('btnSave').disabled=false; } }catch{ setDot(false); } }, 120);
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); } else { init(); }
</script>

<div id="vmEditDlg" class="overlay hide">
  <div class="modal">
    <div class="sectionTitle" style="margin-top:0">编辑视频（标题 / 链接 / 改变部位）</div>
    <div class="row">
      <div class="field"><label>标题</label><input id="vmEditTitle" type="text" placeholder="如：深蹲动作讲解"></div>
      <div class="field"><label>链接</label><input id="vmEditUrl" type="text" placeholder="https://…（YouTube/MP4/链接）"></div>
      <div class="field"><label>部位</label><select id="vmEditPart"></select></div>
    </div>
    <div class="actions">
      <button class="btn light" id="vmEditCancel" type="button">取消</button>
      <button class="btn ok" id="vmEditSave" type="button">保存</button>
    </div>
  </div>
</div>

<script>
(function(){
  function normalize(t){ return (t||'').replace(/\s+/g,'').trim(); }
  function isEdit(t){ t=normalize(t); return t.includes('编辑'); }
  function isDel(t){ t=normalize(t); return t.includes('删除'); }
  function tagRows(){
    var list = document.querySelector('#vmList');
    if(!list) return;
    Array.prototype.forEach.call(list.children, function(row){
      var btns = row.querySelectorAll('button, a');
      var edit=null, del=null;
      btns.forEach(function(b){
        var tx=(b.textContent||'').trim();
        if(!edit && isEdit(tx)) edit=b;
        if(!del  && isDel(tx))  del=b;
      });
      if(edit && del){
        row.classList.add('vm-list-item');
        edit.classList.add('vm-edit');
        del.classList.add('vm-del');
      }
    });
  }
  document.addEventListener('DOMContentLoaded', tagRows);
  setTimeout(tagRows, 400);
  setTimeout(tagRows, 1200);
  var obs = new MutationObserver(tagRows);
  obs.observe(document.body, {childList:true, subtree:true});
})();
</script>
</body>
</html>
